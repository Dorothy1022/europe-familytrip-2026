<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>åŒ—æ­æ—…ç¨‹ (V8 MapFix)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: calc(env(safe-area-inset-bottom) + 20px); }
        .tab-active { color: #3b82f6; border-top: 3px solid #3b82f6; }
        [v-cloak] { display: none; }
        .timeline-line::before { content: ''; position: absolute; left: 24px; top: 44px; bottom: -10px; width: 2px; background: #e2e8f0; z-index: 0; }
        .timeline-last::before { display: none; }
        .sortable-ghost { opacity: 0.2; background: #bfdbfe; border: 2px dashed #3b82f6; }
        .sortable-drag { opacity: 0.9; transform: scale(1.02); cursor: grabbing; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        /* çµ±è¨ˆåˆ‡æ›å‹•ç•« */
        .slide-enter-active, .slide-leave-active { transition: all 0.3s ease; max-height: 200px; opacity: 1; overflow: hidden; }
        .slide-enter-from, .slide-leave-to { max-height: 0; opacity: 0; padding-top: 0; padding-bottom: 0; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">
    <div id="app" v-cloak class="h-screen flex flex-col">
        
        <div v-if="errorMessage" class="bg-red-500 text-white p-3 text-xs font-bold text-center z-50">
            <i class="fas fa-exclamation-triangle mr-1"></i> é€£ç·šéŒ¯èª¤ï¼š{{ errorMessage }}
        </div>

        <header class="bg-white pt-4 px-4 border-b shrink-0 z-20">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-black italic tracking-tighter text-slate-800 uppercase">Nordic 2026 
                    <span class="text-[10px] not-italic bg-green-100 text-green-600 px-2 py-1 rounded ml-2" v-if="dbConnected"><i class="fas fa-check-circle"></i> å·²é€£ç·š</span>
                    <span class="text-[10px] not-italic bg-gray-100 text-gray-500 px-2 py-1 rounded ml-2" v-else-if="!errorMessage"><i class="fas fa-circle-notch fa-spin"></i> é€£ç·šä¸­...</span>
                </h1>
                <div class="flex bg-slate-100 p-1 rounded-xl text-xs font-bold">
                    <button @click="currentGroup = 'all'" :class="currentGroup === 'all' ? 'bg-white shadow text-slate-900' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">å…¨é«”</button>
                    <button @click="currentGroup = 'holland'" :class="currentGroup === 'holland' ? 'bg-blue-500 text-white' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">è·è˜­</button>
                    <button @click="currentGroup = 'baltic'" :class="currentGroup === 'baltic' ? 'bg-orange-500 text-white' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">ä¸‰å°åœ‹</button>
                </div>
            </div>
            <div v-if="activeTab !== 'split'" class="flex overflow-x-auto hide-scrollbar space-x-6 pb-2">
                <div v-for="date in dateRange" :key="date" @click="selectedDate = date"
                     :class="selectedDate === date ? 'text-blue-600 border-b-2 border-blue-600 font-bold' : 'text-slate-400'"
                     class="whitespace-nowrap px-1 py-1 text-sm cursor-pointer transition-all">{{ formatDate(date) }}</div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scrollbar relative pb-24">
            
            <section v-if="activeTab === 'schedule'" class="p-4">
                <div class="flex justify-between items-center mb-4 bg-blue-50 p-3 rounded-xl border border-blue-100">
                    <h2 class="text-xs font-bold text-blue-600"><i class="fas fa-magic mr-1"></i>ç§»å‹•è¡Œç¨‹å°‡åŒæ­¥è‡³é›²ç«¯</h2>
                    <div class="text-[10px] text-blue-400">é•·æŒ‰å¡ç‰‡æ’åº</div>
                </div>

                <div v-if="!dbConnected && !errorMessage" class="text-center py-10 text-slate-400"><i class="fas fa-circle-notch fa-spin mr-2"></i>æ­£åœ¨é€£æ¥è³‡æ–™åº«...</div>
                
                <div id="schedule-list" class="space-y-0 pb-10" v-else>
                    <div v-if="filteredSchedule.length === 0" class="text-center py-10 text-slate-300 font-bold border-2 border-dashed border-slate-200 rounded-2xl">ç•¶æ—¥å°šç„¡è¡Œç¨‹</div>
                    <div v-for="(item, index) in filteredSchedule" :key="item.id" :data-id="item.id"
                         class="relative pl-2 mb-2 schedule-item select-none touch-manipulation" 
                         :class="{'timeline-line': index !== filteredSchedule.length - 1, 'timeline-last': index === filteredSchedule.length - 1}">
                        
                        <div @click="openEditModal(item)" class="bg-white p-4 rounded-2xl shadow-sm border-l-4 relative z-10 flex gap-3 cursor-pointer active:scale-95 transition-transform"
                             :class="item.group === 'holland' ? 'border-blue-500' : (item.group === 'baltic' ? 'border-orange-500' : 'border-slate-800')">
                            <div class="flex flex-col items-center justify-center min-w-[50px] border-r border-slate-100 pr-3 pointer-events-none">
                                <span class="text-lg font-black leading-none tracking-tight">{{ item.time }}</span>
                                <span class="text-[10px] text-slate-400 mt-1 font-bold">åœ{{ item.stay }}m</span>
                            </div>
                            <div class="flex-1 overflow-hidden pointer-events-none">
                                <div class="font-bold text-slate-800 truncate text-base">{{ item.location }}</div>
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="text-[10px] px-2 py-0.5 rounded bg-slate-100 text-slate-500 font-bold">{{ getGroupName(item.group) }}</span>
                                    <span v-if="item.note" class="text-[10px] text-slate-400 truncate max-w-[100px]"><i class="far fa-sticky-note mr-1"></i>{{ item.note }}</span>
                                </div>
                            </div>
                            <div class="absolute right-2 top-2 text-slate-200 pointer-events-none"><i class="fas fa-grip-lines"></i></div>
                        </div>

                        <div v-if="index !== filteredSchedule.length - 1" class="ml-14 pl-2 py-3 flex items-center gap-2 text-xs text-slate-400 relative z-0 pointer-events-none">
                            <div class="bg-slate-100 px-2 py-1 rounded-full text-[10px] font-bold"><i class="fas fa-car-side mr-1"></i>äº¤é€šç´„ {{ item.transport }} åˆ†</div>
                        </div>
                    </div>
                </div>
                <button @click="openQuickAdd" class="w-full py-4 mt-2 bg-white border-2 border-dashed border-slate-300 rounded-2xl text-slate-400 font-bold hover:bg-slate-50 transition-colors shadow-sm">+ æ–°å¢è¡Œç¨‹é»</button>
            </section>

            <section v-if="activeTab === 'map'" class="h-full flex flex-col">
                <div id="map-container" class="flex-1 w-full bg-slate-200 z-0"></div>
                <div class="h-1/3 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-10 overflow-y-auto">
                    <h3 class="font-black text-slate-800 mb-3">ç•¶æ—¥è·¯ç·š ({{ filteredSchedule.length }} ç«™)</h3>
                    <div class="space-y-4">
                        <div v-for="(p, idx) in filteredSchedule" class="flex items-start gap-3">
                            <div class="w-6 h-6 rounded-full bg-slate-800 text-white text-[10px] flex items-center justify-center shrink-0 mt-0.5 font-bold">{{ idx + 1 }}</div>
                            <div>
                                <div class="text-sm font-bold">{{ p.location }}</div>
                                <div class="text-xs text-slate-400">{{ p.time }} åˆ°é” Â· åœç•™ {{ p.stay }} åˆ†</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="activeTab === 'split'" class="p-4 space-y-4 pb-32">
                 <div class="bg-slate-900 text-white p-6 rounded-[2rem] shadow-xl overflow-hidden transition-all duration-300">
                    
                    <div class="mb-4">
                        <p class="text-[10px] opacity-60 uppercase tracking-widest mb-3 font-bold">æ‡‰ä»˜å¸³æ¬¾ (çµç®—å ±å‘Š)</p>
                        
                        <div v-if="settlements.length === 0" class="text-center text-sm opacity-50 py-2">ç›®å‰å¸³ç›®å¹³è¡¡ï¼Œç„¡é ˆè½‰å¸³</div>
                        
                        <div class="space-y-2">
                            <div v-for="s in settlements" class="bg-white/10 px-3 py-2 rounded-lg flex items-center justify-between">
                                <span class="text-sm font-bold flex items-center gap-2">
                                    <span class="text-red-300">{{ s.from }}</span> 
                                    <i class="fas fa-caret-right text-white/40"></i> 
                                    <span class="text-green-300">{{ s.to }}</span>
                                </span>
                                <span class="font-mono font-black text-blue-300">NT$ {{ Math.round(s.amount) }}</span>
                            </div>
                        </div>
                    </div>

                    <div @click="showStats = !showStats" class="border-t border-white/10 pt-3 mt-2 flex justify-between items-center cursor-pointer hover:bg-white/5 -mx-6 px-6 py-2 transition-colors">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-chart-pie text-xs opacity-70"></i>
                            <span class="text-xs font-bold">æŸ¥çœ‹ç¸½æ”¯å‡ºçµ±è¨ˆ</span>
                        </div>
                        <i class="fas text-xs opacity-50 transition-transform duration-300" :class="showStats ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    </div>

                    <transition name="slide">
                        <div v-if="showStats" class="pt-4 border-t border-white/5">
                            <div class="flex bg-white/10 p-1 rounded-lg text-[10px] font-bold mb-4">
                                <button @click.stop="statsFilter = 'all'" :class="statsFilter === 'all' ? 'bg-white text-slate-900 shadow' : 'text-slate-400'" class="flex-1 py-1.5 rounded transition-all">å…¨é«”</button>
                                <button @click.stop="statsFilter = 'holland'" :class="statsFilter === 'holland' ? 'bg-blue-500 text-white shadow' : 'text-slate-400'" class="flex-1 py-1.5 rounded transition-all">è·è˜­</button>
                                <button @click.stop="statsFilter = 'baltic'" :class="statsFilter === 'baltic' ? 'bg-orange-500 text-white shadow' : 'text-slate-400'" class="flex-1 py-1.5 rounded transition-all">ä¸‰å°åœ‹</button>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] opacity-60 uppercase">è©²çµ„åˆ¥ç´¯ç©ç¸½æ”¯å‡º</p>
                                <p class="text-3xl font-black mt-1 text-yellow-400">NT$ {{ Math.round(statsTotal).toLocaleString() }}</p>
                            </div>
                        </div>
                    </transition>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar gap-2">
                    <div v-for="p in members" class="bg-white p-3 rounded-2xl border min-w-[90px] text-center shadow-sm">
                        <p class="text-[10px] text-slate-400 font-bold mb-1">{{ p }}</p>
                        <p class="text-xs font-black" :class="balances[p] >= 0 ? 'text-green-600' : 'text-red-500'">
                            {{ balances[p] > 0 ? '+' : '' }}{{ Math.round(balances[p]) }}
                        </p>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                    <h3 class="text-xs font-bold text-slate-400 mb-3 ml-1">é¸æ“‡æ—¥æœŸæŸ¥çœ‹æ”¯å‡º ({{formatDate(selectedDate)}})</h3>
                    <div class="calendar-grid mb-1">
                        <div v-for="d in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" class="text-center text-[10px] text-slate-300 font-bold">{{d}}</div>
                    </div>
                    <div class="calendar-grid">
                        <div v-for="d in calendarDays" :key="d.date" @click="selectedDate = d.fullDate"
                             class="aspect-square flex flex-col items-center justify-center rounded-xl text-xs relative cursor-pointer transition-colors"
                             :class="[selectedDate === d.fullDate ? 'bg-slate-900 text-white shadow-md' : 'text-slate-600 hover:bg-slate-50', d.isCurrentMonth ? '' : 'opacity-20 pointer-events-none']">
                            <span class="font-bold">{{ d.date }}</span>
                            <div v-if="hasExpense(d.fullDate)" class="w-1 h-1 rounded-full mt-0.5" :class="selectedDate === d.fullDate ? 'bg-orange-400' : 'bg-orange-500'"></div>
                        </div>
                    </div>
                </div>

                <div v-for="exp in filteredExpenses" :key="exp.id" @click="openEditExpense(exp)" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50 active:bg-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs text-slate-600">{{ exp.payer[0] }}</div>
                        <div><p class="font-bold text-sm text-slate-800">{{ exp.desc }}</p><p class="text-[10px] text-slate-400">{{ formatDate(exp.date) }} Â· {{ exp.payer }} ä»˜</p></div>
                    </div>
                    <div class="text-right font-mono">
                        <p class="font-black text-slate-800 text-sm">{{ exp.currency === 'EUR' ? 'â‚¬' : 'NT$' }} {{ exp.amount }}</p>
                        <p v-if="exp.currency === 'EUR'" class="text-[9px] text-slate-400">ç´„ NT$ {{ Math.round(exp.amount * exp.rate) }}</p>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bg-white/90 backdrop-blur border-t flex justify-around items-center safe-bottom h-20 shrink-0 z-30 absolute bottom-0 w-full">
            <button @click="activeTab = 'schedule'" :class="activeTab === 'schedule' ? 'tab-active' : 'text-slate-400'" class="flex-1 flex flex-col items-center pt-2 h-full"><i class="fas fa-route text-lg"></i><span class="text-[10px] mt-1 font-bold">è¡Œç¨‹</span></button>
            <div @click="openQuickAdd" class="w-14 h-14 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg -mt-8 border-4 border-slate-50 cursor-pointer active:scale-95 transition-transform"><i class="fas fa-plus text-xl"></i></div>
            <button @click="activeTab = 'map'" :class="activeTab === 'map' ? 'tab-active' : 'text-slate-400'" class="flex-1 flex flex-col items-center pt-2 h-full"><i class="fas fa-map-marked-alt text-lg"></i><span class="text-[10px] mt-1 font-bold">åœ°åœ–</span></button>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'tab-active' : 'text-slate-400'" class="flex-1 flex flex-col items-center pt-2 h-full"><i class="fas fa-receipt text-lg"></i><span class="text-[10px] mt-1 font-bold">åˆ†å¸³</span></button>
        </nav>

        <div v-if="showTripModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end">
            <div class="bg-white w-full rounded-t-[2rem] p-6 pb-8 animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h2>
                    <div class="flex gap-3">
                         <div class="relative" v-if="isEditing">
                             <button @click="showCopyMenu = !showCopyMenu" class="text-blue-500 w-8 h-8 rounded-full bg-blue-50 flex items-center justify-center"><i class="fas fa-copy"></i></button>
                             <div v-if="showCopyMenu" class="absolute right-0 top-10 bg-white shadow-xl border rounded-xl p-3 w-48 z-50">
                                <p class="text-xs font-bold text-slate-400 mb-2">è¤‡è£½åˆ°å“ªå¤©ï¼Ÿ</p>
                                <select v-model="copyTargetDate" class="w-full p-2 bg-slate-50 rounded mb-2 text-sm font-bold"><option v-for="d in dateRange" :value="d">{{ formatDate(d) }}</option></select>
                                <button @click="copyItem" class="w-full bg-blue-500 text-white text-xs py-2 rounded font-bold">ç¢ºèªè¤‡è£½</button>
                             </div>
                        </div>
                        <button v-if="isEditing" @click="deleteItem" class="text-red-400 w-8 h-8 rounded-full bg-red-50 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                        <button @click="showTripModal = false" class="text-slate-300 text-2xl"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="text-xs font-bold text-slate-400 ml-1">åœ°é»åç¨±</label>
                        <input v-model="tempTrip.location" @input="debouncedSearch" placeholder="æœå°‹åœ°é»..." class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold text-lg">
                        <div v-if="osmResults.length > 0" class="absolute left-0 right-0 top-20 bg-white shadow-2xl rounded-xl z-[60] max-h-48 overflow-y-auto border border-slate-100">
                            <div v-for="res in osmResults" @click="selectOSM(res)" class="p-3 hover:bg-slate-50 border-b border-slate-100 flex items-center gap-3 cursor-pointer">
                                <i class="fas fa-map-marker-alt text-red-500"></i><div><div class="font-bold text-sm text-slate-800">{{ res.name }}</div><div class="text-[10px] text-slate-400 truncate w-64">{{ res.address }}</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="text-xs font-bold text-slate-400 ml-1">é–‹å§‹æ™‚é–“</label><input v-model="tempTrip.time" type="time" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold text-center"></div>
                        <div><label class="text-xs font-bold text-slate-400 ml-1">åœç•™ (åˆ†é˜)</label><input v-model.number="tempTrip.stay" type="number" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold text-center" placeholder="60"></div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl">
                        <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-blue-600">åˆ°ä¸‹ä¸€ç«™äº¤é€š (åˆ†)</label><button @click="openGoogleMaps" class="text-[10px] bg-white text-blue-600 px-2 py-1 rounded shadow-sm font-bold border border-blue-100">Map ä¼°ç®—</button></div>
                        <input v-model.number="tempTrip.transport" type="number" class="w-full p-3 bg-white rounded-lg outline-none font-bold text-center text-blue-800" placeholder="30">
                    </div>
                    <div><label class="text-xs font-bold text-slate-400 ml-1">æ­¸å±¬çµ„åˆ¥</label><select v-model="tempTrip.group" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold"><option value="all">ğŸŒ å…¨é«”åƒåŠ </option><option value="holland">ğŸ”µ è·è˜­çµ„</option><option value="baltic">ğŸŸ  ä¸‰å°åœ‹</option></select></div>
                    <textarea v-model="tempTrip.note" placeholder="å‚™è¨»..." class="w-full p-4 bg-slate-50 rounded-xl outline-none h-20 text-sm"></textarea>
                    <button @click="saveTrip" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold text-lg shadow-lg">ç¢ºèªå„²å­˜</button>
                </div>
            </div>
        </div>

        <div v-if="showExpModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-end">
            <div class="bg-white w-full rounded-t-[2rem] p-6 pb-8 animate-slide-up max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">{{ isEditingExp ? 'ä¿®æ”¹æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}</h2>
                    <button @click="showExpModal = false" class="text-slate-300 text-2xl"><i class="fas fa-times-circle"></i></button>
                </div>
                <div class="space-y-5">
                    <input v-model="tempExp.desc" placeholder="æ¶ˆè²»é …ç›®" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold text-lg">
                    <div class="flex gap-3">
                        <div class="flex-1 relative"><label class="text-[10px] font-bold text-slate-400 absolute top-2 left-3">é‡‘é¡</label><input v-model.number="tempExp.amount" type="number" class="w-full pt-6 pb-2 px-3 bg-slate-50 rounded-xl outline-none font-mono font-black text-xl"></div>
                        <select v-model="tempExp.currency" class="w-24 p-2 bg-slate-100 rounded-xl outline-none font-bold text-center"><option value="TWD">NT$</option><option value="EUR">â‚¬ EUR</option></select>
                    </div>
                    <div v-if="tempExp.currency === 'EUR'" class="p-4 bg-blue-50 border border-blue-100 rounded-xl flex items-center justify-between animate-slide-up">
                        <div><div class="text-xs font-bold text-blue-800">æ­å…ƒåŒ¯ç‡ (1â‚¬ = ? TWD)</div></div>
                        <input v-model.number="tempExp.rate" type="number" class="w-20 bg-white border border-blue-200 rounded p-2 text-right font-bold text-blue-800 outline-none">
                    </div>
                    <div><p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">å…ˆä»˜éŒ¢çš„äºº</p><div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1"><button v-for="p in members" @click="tempExp.payer = p" :class="tempExp.payer === p ? 'bg-slate-800 text-white' : 'bg-slate-50 text-slate-500'" class="px-4 py-3 rounded-xl whitespace-nowrap text-xs font-bold transition-all flex-1">{{ p }}</button></div></div>
                    <div>
                        <div class="flex justify-between items-end mb-2">
                            <p class="text-[10px] font-bold text-slate-400 uppercase">åˆ†æ”¤å°è±¡</p>
                            <div class="flex gap-2">
                                <button @click="setSplitGroup('all')" class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold hover:bg-slate-200">å…¨é¸</button>
                                <button @click="setSplitGroup('holland')" class="text-[10px] bg-blue-50 px-2 py-1 rounded text-blue-500 font-bold hover:bg-blue-100">è·è˜­</button>
                                <button @click="setSplitGroup('baltic')" class="text-[10px] bg-orange-50 px-2 py-1 rounded text-orange-500 font-bold hover:bg-orange-100">ä¸‰å°åœ‹</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-2"><label v-for="p in members" class="flex items-center justify-center gap-2 p-3 bg-slate-50 rounded-xl text-xs font-bold cursor-pointer transition-colors" :class="tempExp.splitWith.includes(p) ? 'bg-blue-50 text-blue-600 ring-1 ring-blue-200' : ''"><input type="checkbox" :value="p" v-model="tempExp.splitWith" class="hidden"> {{ p }}</label></div>
                    </div>
                    <div class="flex gap-3 pt-2">
                        <button v-if="isEditingExp" @click="deleteExpense" class="flex-1 py-4 bg-red-50 text-red-500 rounded-xl font-bold">åˆªé™¤</button>
                        <button @click="saveExpense" class="flex-[2] py-4 bg-slate-900 text-white rounded-xl font-bold shadow-lg">å„²å­˜</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const { createApp, ref, computed, watch, nextTick, onMounted } = Vue;

        const firebaseConfig = {
          apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
          authDomain: "europetrip2026-d36f1.firebaseapp.com",
          databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
          projectId: "europetrip2026-d36f1",
          storageBucket: "europetrip2026-d36f1.firebasestorage.app",
          messagingSenderId: "368850353659",
          appId: "1:368850353659:web:8cc22ae3fcf13d11051f5e"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        createApp({
            setup() {
                const activeTab = ref('schedule');
                const currentGroup = ref('all');
                const selectedDate = ref('2026-03-19');
                const showSettlement = ref(true); // é»‘è‰²å¡ç‰‡æ˜¯å¦é¡¯ç¤ºè©³ç´° (ç›®å‰ç”¨æ–¼CSS transition)
                const showStats = ref(false); // æ˜¯å¦é¡¯ç¤ºçµ±è¨ˆå€å¡Š
                const statsFilter = ref('all'); // çµ±è¨ˆéæ¿¾å™¨
                const dbConnected = ref(false);
                const loading = ref(true);
                const errorMessage = ref('');

                const members = ['åª½åª½', 'ä½©çª', 'æ©çª', 'ä¸€ä¼‘', 'éŒ¦ç›†'];
                const groupMap = { holland: 'è·è˜­çµ„', baltic: 'ä¸‰å°åœ‹', all: 'å…¨é«”' };
                const groupMembers = {
                    holland: ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†'],
                    baltic: ['æ©çª', 'ä¸€ä¼‘'],
                    all: ['åª½åª½', 'ä½©çª', 'æ©çª', 'ä¸€ä¼‘', 'éŒ¦ç›†']
                };

                const dateRange = [];
                const start = new Date('2026-03-19');
                const end = new Date('2026-04-04');
                for(let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(d.toISOString().split('T')[0]);
                }

                const schedule = ref([]);
                const expenses = ref([]);

                onMounted(() => {
                    const qSchedule = collection(db, "schedule");
                    onSnapshot(qSchedule, 
                        (snapshot) => {
                            schedule.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            loading.value = false;
                            dbConnected.value = true;
                            errorMessage.value = '';
                            if (activeTab.value === 'schedule') nextTick(initSortable);
                        }, 
                        (error) => {
                            errorMessage.value = error.message;
                            loading.value = false;
                        }
                    );

                    const qExpenses = collection(db, "expenses");
                    onSnapshot(qExpenses, (snapshot) => {
                        expenses.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                let sortableInstance = null;
                const initSortable = () => {
                    const el = document.getElementById('schedule-list');
                    if (!el) return;
                    if (sortableInstance) sortableInstance.destroy();
                    sortableInstance = new Sortable(el, {
                        animation: 200, delay: 150, delayOnTouchOnly: true, handle: '.schedule-item',
                        onEnd: async (evt) => {
                            const { oldIndex, newIndex } = evt;
                            if (oldIndex === newIndex) return;
                            const visibleItems = [...filteredSchedule.value];
                            const movedItem = visibleItems.splice(oldIndex, 1)[0];
                            visibleItems.splice(newIndex, 0, movedItem);
                            let currentTime = new Date(`2000-01-01T${visibleItems[0].time}`);
                            const batch = writeBatch(db);
                            visibleItems.forEach((item, index) => {
                                if (index > 0) {
                                    const prevItem = visibleItems[index - 1];
                                    const addMin = (prevItem.stay || 0) + (prevItem.transport || 0);
                                    currentTime.setMinutes(currentTime.getMinutes() + addMin);
                                    const h = String(currentTime.getHours()).padStart(2, '0');
                                    const m = String(currentTime.getMinutes()).padStart(2, '0');
                                    item.time = `${h}:${m}`;
                                }
                                const ref = doc(db, "schedule", item.id);
                                batch.update(ref, { time: item.time }); 
                            });
                            await batch.commit();
                        }
                    });
                };

                const saveTrip = async () => {
                    if (isEditing.value) {
                        const tripRef = doc(db, "schedule", tempTrip.value.id);
                        const { id, ...data } = tempTrip.value; 
                        await updateDoc(tripRef, data);
                    } else { await addDoc(collection(db, "schedule"), tempTrip.value); }
                    showTripModal.value = false;
                };

                const deleteItem = async () => { await deleteDoc(doc(db, "schedule", tempTrip.value.id)); showTripModal.value = false; };
                const copyItem = async () => { const newItem = { ...tempTrip.value, date: copyTargetDate.value }; delete newItem.id; await addDoc(collection(db, "schedule"), newItem); showCopyMenu.value = false; showTripModal.value = false; alert('å·²è¤‡è£½åˆ°é›²ç«¯'); };
                const saveExpense = async () => {
                    tempExp.value.date = selectedDate.value;
                    if (isEditingExp.value) { const expRef = doc(db, "expenses", tempExp.value.id); const { id, ...data } = tempExp.value; await updateDoc(expRef, data); }
                    else { await addDoc(collection(db, "expenses"), tempExp.value); }
                    showExpModal.value = false;
                };
                const deleteExpense = async () => { await deleteDoc(doc(db, "expenses", tempExp.value.id)); showExpModal.value = false; };

                const filteredSchedule = computed(() => {
                    let list = schedule.value.filter(i => i.date === selectedDate.value && (currentGroup.value === 'all' || i.group === currentGroup.value || i.group === 'all'));
                    return list.sort((a, b) => a.time.localeCompare(b.time));
                });
                
                // --- Map Fix & UI Logic ---
                const filteredExpenses = computed(() => expenses.value.filter(e => e.date === selectedDate.value));
                
                // çµ±è¨ˆè¨ˆç®— (ä¾æ“šåˆ†æ”¤å°è±¡æ˜¯å¦åŒ…å«è©²çµ„æˆå“¡)
                const statsTotal = computed(() => {
                    return expenses.value.reduce((sum, exp) => {
                        const amt = exp.currency === 'EUR' ? exp.amount * (exp.rate || 37) : exp.amount;
                        if (statsFilter.value === 'all') return sum + amt;
                        const targetMembers = groupMembers[statsFilter.value];
                        // é‚è¼¯ï¼šåªè¦è©²ç­†æ”¯å‡ºçš„ã€Œåˆ†æ”¤å°è±¡ã€è£¡æœ‰è©²çµ„æˆå“¡ï¼Œå°±è¨ˆå…¥è©²çµ„çš„ç¸½é–‹éŠ· (ç¸½é¡)
                        // è‹¥è¦æ›´ç²¾ç¢ºåªç®—"è©²çµ„çš„ä»½é¡"ï¼Œé‚è¼¯æœƒæ›´è¤‡é›œï¼Œé€™è£¡å…ˆç®—"è©²çµ„åƒèˆ‡çš„ç¸½æ´»å‹•é‡‘é¡"
                        const isInvolved = exp.splitWith.some(m => targetMembers.includes(m));
                        return isInvolved ? sum + amt : sum;
                    }, 0);
                });

                const calendarDays = computed(() => {
                    const curr = new Date(selectedDate.value);
                    const y = curr.getFullYear(), m = curr.getMonth();
                    const firstDay = new Date(y, m, 1);
                    const startDay = firstDay.getDay();
                    const days = [];
                    for(let i=0; i<startDay; i++) days.push({ date: '', isCurrentMonth: false, fullDate: '' });
                    const lastDate = new Date(y, m+1, 0).getDate();
                    for(let i=1; i<=lastDate; i++) {
                        const mm = String(m+1).padStart(2,'0');
                        const dd = String(i).padStart(2,'0');
                        days.push({ date: i, isCurrentMonth: true, fullDate: `${y}-${mm}-${dd}` });
                    }
                    return days;
                });
                const hasExpense = (d) => expenses.value.some(e => e.date === d);
                const balances = computed(() => { let b = {}; members.forEach(m => b[m] = 0); expenses.value.forEach(e => { const val = e.currency === 'EUR' ? e.amount * (e.rate || 37) : e.amount; b[e.payer] += val; const share = val / e.splitWith.length; e.splitWith.forEach(m => b[m] -= share); }); return b; });
                const settlements = computed(() => { const b = { ...balances.value }; const debtors = [], creditors = []; for (let m in b) { if (b[m] < -1) debtors.push({ name: m, amount: Math.abs(b[m]) }); else if (b[m] > 1) creditors.push({ name: m, amount: b[m] }); } const res = []; let i = 0, j = 0; while (i < debtors.length && j < creditors.length) { const amt = Math.min(debtors[i].amount, creditors[j].amount); res.push({ from: debtors[i].name, to: creditors[j].name, amount: amt }); debtors[i].amount -= amt; creditors[j].amount -= amt; if (debtors[i].amount < 1) i++; if (creditors[j].amount < 1) j++; } return res; });

                const showTripModal = ref(false); const showExpModal = ref(false); const isEditing = ref(false); const isEditingExp = ref(false);
                const tempTrip = ref({}); const tempExp = ref({}); const showCopyMenu = ref(false); const copyTargetDate = ref('');
                const osmResults = ref([]); const searchTimeout = ref(null);

                const debouncedSearch = () => { clearTimeout(searchTimeout.value); searchTimeout.value = setTimeout(searchOSM, 500); };
                const searchOSM = async () => { if (!tempTrip.value.location) return; try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(tempTrip.value.location)}&limit=5`); const data = await res.json(); osmResults.value = data.map(item => ({ name: item.display_name.split(',')[0], address: item.display_name, lat: parseFloat(item.lat), lon: parseFloat(item.lon) })); } catch (e) {} };
                const selectOSM = (res) => { tempTrip.value.location = res.name; tempTrip.value.lat = res.lat; tempTrip.value.lon = res.lon; osmResults.value = []; };
                const formatDate = (d) => { const p = d.split('-'); return `${p[1]}/${p[2]}`; };
                const getGroupName = (g) => groupMap[g];
                const openQuickAdd = () => { if (activeTab.value === 'split') { isEditingExp.value = false; tempExp.value = { desc: '', amount: null, currency: 'TWD', payer: 'åª½åª½', splitWith: [...members], rate: 37 }; showExpModal.value = true; } else { isEditing.value = false; tempTrip.value = { date: selectedDate.value, time: '09:00', stay: 60, transport: 30, location: '', group: currentGroup.value === 'all' ? 'all' : currentGroup.value }; showTripModal.value = true; } };
                const openEditModal = (item) => { isEditing.value = true; tempTrip.value = { ...item }; copyTargetDate.value = item.date; showCopyMenu.value = false; showTripModal.value = true; };
                const openEditExpense = (e) => { isEditingExp.value = true; tempExp.value = { ...e }; showExpModal.value = true; };
                const setSplitGroup = (group) => { tempExp.value.splitWith = [...groupMembers[group]]; };
                const toggleAllSplit = () => { tempExp.value.splitWith = tempExp.value.splitWith.length === members.length ? [] : [...members]; };
                const openGoogleMaps = () => { const list = filteredSchedule.value; const idx = list.findIndex(s => s.id === tempTrip.value.id); let origin = idx > 0 ? list[idx - 1].location : (list.length > 0 ? list[list.length - 1].location : ""); if (origin && tempTrip.value.location) window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(tempTrip.value.location)}&travelmode=driving`, '_blank'); };
                
                let map = null; let markers = [];
                const initMap = () => { if (map) return; map = L.map('map-container').setView([52.3, 4.7], 10); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); };
                const updateMap = () => {
                    if (!map) return; markers.forEach(m => map.removeLayer(m)); markers = [];
                    const items = filteredSchedule.value.filter(i => i.lat);
                    if (items.length > 0) {
                        const points = items.map((i, idx) => {
                             const icon = L.divIcon({ className: 'custom-div-icon', html: `<div style="background-color:#1e293b;width:24px;height:24px;border-radius:50%;color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;border:2px solid white;">${idx+1}</div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
                             const m = L.marker([i.lat, i.lon], {icon}).addTo(map).bindPopup(i.location);
                             markers.push(m);
                             return [i.lat, i.lon];
                        });
                        map.fitBounds(L.latLngBounds(points), { padding: [50, 50] });
                    }
                };
                watch(activeTab, (val) => { if (val === 'map') nextTick(() => { initMap(); updateMap(); }); });
                // é—œéµä¿®å¾©ï¼šç›£è½ filteredSchedule è®Šå‹•ï¼Œç¢ºä¿åœ°åœ–å³æ™‚æ›´æ–°
                watch(filteredSchedule, () => { if (activeTab.value === 'map') nextTick(updateMap); }, { deep: true });
                watch(selectedDate, () => { if (activeTab.value === 'schedule') nextTick(initSortable); });

                return {
                    activeTab, currentGroup, selectedDate, dateRange, members, getGroupName, dbConnected, loading, errorMessage,
                    filteredSchedule, filteredExpenses, balances, settlements, showSettlement, showStats, statsFilter, statsTotal,
                    showTripModal, showExpModal, isEditing, isEditingExp, tempTrip, tempExp,
                    osmResults, debouncedSearch, selectOSM,
                    openQuickAdd, openEditModal, saveTrip, deleteItem, openEditExpense, saveExpense, deleteExpense,
                    formatDate, toggleAllSplit, setSplitGroup, openGoogleMaps, copyItem, showCopyMenu, copyTargetDate, calendarDays, hasExpense
                };
            }
        }).mount('#app');
    </script>
</body>
</html>