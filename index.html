<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>北歐旅程小幫手 V3</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        [v-cloak] { display: none; }
        #map-container { height: 300px; width: 100%; border-radius: 1rem; z-index: 10; }
        .tab-active { color: #3b82f6; border-top: 3px solid #3b82f6; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900 overflow-hidden">
    <div id="app" v-cloak class="h-screen flex flex-col">
        
        <header class="bg-white pt-4 px-4 border-b shrink-0">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-xl font-black italic tracking-tighter text-slate-800 uppercase">Nordic 2026</h1>
                <div class="flex bg-slate-100 p-1 rounded-xl text-xs font-bold">
                    <button @click="currentGroup = 'all'" :class="currentGroup === 'all' ? 'bg-white shadow-sm text-slate-900' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">全體</button>
                    <button @click="currentGroup = 'holland'" :class="currentGroup === 'holland' ? 'bg-blue-500 text-white' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">荷蘭</button>
                    <button @click="currentGroup = 'baltic'" :class="currentGroup === 'baltic' ? 'bg-orange-500 text-white' : 'text-slate-400'" class="px-3 py-1.5 rounded-lg transition-all">三小國</button>
                </div>
            </div>

            <div v-if="activeTab !== 'split'" class="flex overflow-x-auto hide-scrollbar space-x-6 pb-2">
                <div v-for="date in dateRange" :key="date" 
                     @click="selectedDate = date"
                     :class="selectedDate === date ? 'text-blue-600 border-b-2 border-blue-600 font-bold' : 'text-slate-400'"
                     class="whitespace-nowrap px-1 py-1 text-sm cursor-pointer transition-all">
                    {{ formatDate(date) }}
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto hide-scrollbar relative">
            
            <section v-if="activeTab === 'schedule'" class="p-4 space-y-3">
                <div v-for="item in filteredSchedule" :key="item.id" 
                     @click="openEditModal(item)"
                     class="bg-white p-4 rounded-2xl shadow-sm border-l-4 flex justify-between items-center"
                     :class="item.group === 'holland' ? 'border-blue-500' : (item.group === 'baltic' ? 'border-orange-500' : 'border-slate-300')">
                    <div class="flex-1">
                        <div class="text-[10px] font-bold text-slate-400">{{ item.time }}</div>
                        <div class="font-bold text-slate-800">{{ item.location }}</div>
                        <div v-if="item.note" class="text-xs text-slate-500 mt-1"><i class="far fa-sticky-note mr-1"></i>{{ item.note }}</div>
                    </div>
                    <i class="fas fa-chevron-right text-slate-200"></i>
                </div>
                <div v-if="filteredSchedule.length === 0" class="text-center py-10 text-slate-300 font-bold">當日尚無行程</div>
            </section>

            <section v-if="activeTab === 'map'" class="p-4 flex flex-col h-full">
                <div id="map-container" class="mb-4"></div>
                <div class="flex-1 bg-white rounded-2xl p-4 shadow-sm overflow-y-auto">
                    <h3 class="font-black text-slate-800 mb-3 underline decoration-blue-500 underline-offset-4">當日路徑點</h3>
                    <div v-for="(p, idx) in filteredSchedule" class="flex gap-3 mb-4">
                        <span class="w-6 h-6 rounded-full bg-slate-800 text-white text-[10px] flex items-center justify-center shrink-0">{{ idx + 1 }}</span>
                        <div class="text-sm font-bold">{{ p.location }} <span class="text-[10px] text-slate-400 ml-2">{{ p.time }}</span></div>
                    </div>
                </div>
            </section>

            <section v-if="activeTab === 'split'" class="p-4 space-y-4 pb-20">
                <div class="bg-slate-900 text-white p-6 rounded-[2rem] shadow-xl">
                    <div @click="showSettlement = !showSettlement" class="flex justify-between items-center cursor-pointer">
                        <div>
                            <p class="text-[10px] opacity-60 uppercase tracking-widest">結算報告 (EUR)</p>
                            <p class="text-3xl font-black">應付帳款明細</p>
                        </div>
                        <i class="fas" :class="showSettlement ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                    </div>
                    
                    <div v-show="showSettlement" class="mt-6 space-y-3 pt-6 border-t border-white/10">
                        <div v-if="settlements.length === 0" class="text-center text-sm opacity-50">目前帳目平衡，無須轉帳</div>
                        <div v-for="s in settlements" class="bg-white/5 p-3 rounded-xl flex items-center justify-between">
                            <span class="text-sm font-bold"><span class="text-red-400">{{ s.from }}</span> ➔ <span class="text-green-400">{{ s.to }}</span></span>
                            <span class="font-mono font-black text-blue-400">€ {{ s.amount.toFixed(2) }}</span>
                        </div>
                    </div>
                </div>

                <div class="flex overflow-x-auto hide-scrollbar gap-2">
                    <div v-for="p in members" class="bg-white p-3 rounded-2xl border min-w-[85px] text-center">
                        <p class="text-[10px] text-slate-400 font-bold mb-1">{{ p }}</p>
                        <p class="text-xs font-black" :class="balances[p] >= 0 ? 'text-green-600' : 'text-red-500'">
                            {{ balances[p] > 0 ? '+' : '' }}{{ balances[p].toFixed(1) }}
                        </p>
                    </div>
                </div>

                <h3 class="font-black text-slate-800 mt-4">所有支出</h3>
                <div v-for="exp in expenses" :key="exp.id" @click="openEditExpense(exp)" class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-50">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center font-bold text-xs">{{ exp.payer[0] }}</div>
                        <div>
                            <p class="font-bold text-sm">{{ exp.desc }}</p>
                            <p class="text-[10px] text-slate-400">{{ exp.date }} · {{ exp.payer }} 付</p>
                        </div>
                    </div>
                    <div class="text-right font-mono">
                        <p class="font-black text-slate-800 text-sm">{{ exp.currency === 'TWD' ? 'NT$' : '€' }} {{ exp.amount }}</p>
                        <p v-if="exp.currency === 'TWD'" class="text-[9px] text-slate-400 italic">約 € {{ (exp.amount / exp.rate).toFixed(1) }}</p>
                    </div>
                </div>
            </section>
        </main>

        <nav class="bg-white border-t flex justify-around items-center safe-bottom h-20 shrink-0 z-[1000]">
            <button @click="activeTab = 'schedule'" :class="activeTab === 'schedule' ? 'tab-active' : ''" class="flex-1 flex flex-col items-center pt-2">
                <i class="fas fa-calendar-day text-lg"></i><span class="text-[10px] mt-1 font-bold">行程</span>
            </button>
            <button @click="activeTab = 'map'" :class="activeTab === 'map' ? 'tab-active' : ''" class="flex-1 flex flex-col items-center pt-2">
                <i class="fas fa-map-marked-alt text-lg"></i><span class="text-[10px] mt-1 font-bold">地圖</span>
            </button>
            <div @click="openQuickAdd" class="w-14 h-14 bg-slate-900 text-white rounded-full flex items-center justify-center shadow-lg -mt-10 border-4 border-slate-50">
                <i class="fas fa-plus"></i>
            </div>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'tab-active' : ''" class="flex-1 flex flex-col items-center pt-2">
                <i class="fas fa-wallet text-lg"></i><span class="text-[10px] mt-1 font-bold">分帳</span>
            </button>
        </nav>

        <div v-if="showTripModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] flex items-end">
            <div class="bg-white w-full rounded-t-[2rem] p-6 pb-12 animate-slide-up">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">編輯行程內容</h2>
                    <div class="flex gap-4">
                        <button @click="deleteItem" v-if="isEditing" class="text-red-400"><i class="fas fa-trash"></i></button>
                        <button @click="showTripModal = false" class="text-slate-300 text-2xl"><i class="fas fa-times-circle"></i></button>
                    </div>
                </div>
                
                <div class="space-y-4">
                    <div class="relative">
                        <div class="flex gap-2">
                            <input v-model="tempTrip.location" placeholder="搜尋全球地點 (如: 桃園機場)" class="flex-1 p-4 bg-slate-50 rounded-xl outline-none font-bold">
                            <button @click="searchOSM" class="px-4 bg-blue-500 text-white rounded-xl"><i class="fas fa-search"></i></button>
                        </div>
                        <div v-if="searchLoading" class="text-[10px] mt-1 text-blue-500">搜尋中...</div>
                        <div v-if="osmResults.length > 0" class="absolute left-0 right-0 top-16 bg-white shadow-2xl rounded-xl z-[2100] max-h-48 overflow-y-auto border">
                            <div v-for="res in osmResults" @click="selectOSM(res)" class="p-4 hover:bg-slate-50 border-b text-sm cursor-pointer">
                                {{ res.display_name }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 text-sm">
                        <input v-model="tempTrip.time" type="time" class="flex-1 p-4 bg-slate-50 rounded-xl outline-none">
                        <select v-model="tempTrip.group" class="flex-1 p-4 bg-slate-50 rounded-xl outline-none font-bold">
                            <option value="all">全體行程</option>
                            <option value="holland">荷蘭組專屬</option>
                            <option value="baltic">三小國專屬</option>
                        </select>
                    </div>

                    <textarea v-model="tempTrip.note" placeholder="備註..." class="w-full p-4 bg-slate-50 rounded-xl outline-none h-20 text-sm"></textarea>
                    
                    <div class="flex gap-2 pt-4">
                        <button @click="saveTrip" class="flex-1 py-4 bg-slate-900 text-white rounded-xl font-bold">儲存並更新</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showExpModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[2000] flex items-end">
            <div class="bg-white w-full rounded-t-[2rem] p-6 pb-12 animate-slide-up max-h-[85vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-black">新增支出項目</h2>
                    <button @click="showExpModal = false" class="text-slate-300 text-2xl"><i class="fas fa-times-circle"></i></button>
                </div>
                
                <div class="space-y-4">
                    <input v-model="tempExp.desc" placeholder="項目描述 (例如: 午餐)" class="w-full p-4 bg-slate-50 rounded-xl outline-none font-bold">
                    
                    <div class="flex gap-2">
                        <input v-model.number="tempExp.amount" type="number" class="flex-[2] p-4 bg-slate-50 rounded-xl outline-none font-mono font-bold text-lg">
                        <select v-model="tempExp.currency" class="flex-1 p-4 bg-slate-100 rounded-xl outline-none font-bold">
                            <option value="EUR">€ EUR</option>
                            <option value="TWD">NT$ TWD</option>
                        </select>
                    </div>

                    <div v-if="tempExp.currency === 'TWD'" class="p-3 bg-blue-50 rounded-xl flex justify-between items-center text-xs">
                        <span class="font-bold text-blue-600">匯率設定 (1€ =)</span>
                        <input v-model.number="exchangeRate" type="number" class="w-20 bg-transparent text-right outline-none font-bold border-b border-blue-300">
                    </div>

                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">付錢的人</p>
                        <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                            <button v-for="p in members" @click="tempExp.payer = p" 
                                    :class="tempExp.payer === p ? 'bg-slate-900 text-white' : 'bg-slate-50'"
                                    class="px-4 py-2 rounded-full whitespace-nowrap text-xs transition-all">{{ p }}</button>
                        </div>
                    </div>

                    <div>
                        <p class="text-[10px] font-bold text-slate-400 mb-2 uppercase">誰要分攤</p>
                        <div class="grid grid-cols-3 gap-2">
                            <label v-for="p in members" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl text-xs font-bold">
                                <input type="checkbox" :value="p" v-model="tempExp.splitWith" class="rounded"> {{ p }}
                            </label>
                        </div>
                    </div>

                    <button @click="saveExpense" class="w-full py-4 bg-slate-900 text-white rounded-xl font-bold mt-4 shadow-lg">確認送出</button>
                    <button v-if="isEditingExp" @click="deleteExpense" class="w-full py-2 text-red-400 text-sm font-bold">刪除此帳目</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, watch, nextTick } = Vue;

        createApp({
            setup() {
                const activeTab = ref('schedule');
                const currentGroup = ref('all');
                const selectedDate = ref('2026-03-19');
                const showSettlement = ref(true);
                const exchangeRate = ref(37);
                
                const members = ['媽媽', '佩琪', '恩琪', '一休', '錦盆'];
                const dateRange = [];
                const start = new Date('2026-03-19');
                const end = new Date('2026-04-04');
                for(let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                    dateRange.push(d.toISOString().split('T')[0]);
                }

                const schedule = ref([
                    { id: 1, date: '2026-03-19', time: '12:00', location: '桃園國際機場', group: 'all', lat: 25.0797, lon: 121.2342, note: '集合' }
                ]);

                const expenses = ref([]);

                // 地圖相關
                let map = null;
                let markers = [];

                const initMap = () => {
                    if (map) return;
                    map = L.map('map-container').setView([25.079, 121.234], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                };

                const updateMap = () => {
                    if (!map) return;
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                    const items = filteredSchedule.value.filter(i => i.lat);
                    if (items.length > 0) {
                        const points = items.map(i => {
                            const m = L.marker([i.lat, i.lon]).addTo(map).bindPopup(i.location);
                            markers.push(m);
                            return [i.lat, i.lon];
                        });
                        map.fitBounds(L.latLngBounds(points), { padding: [50, 50] });
                    }
                };

                watch([activeTab, selectedDate, currentGroup, schedule], () => {
                    if (activeTab.value === 'map') {
                        nextTick(() => {
                            initMap();
                            updateMap();
                        });
                    }
                }, { deep: true });

                // OSM 搜尋
                const osmResults = ref([]);
                const searchLoading = ref(false);
                const searchOSM = async () => {
                    if (!tempTrip.value.location) return;
                    searchLoading.value = true;
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(tempTrip.value.location)}`);
                        osmResults.value = await res.json();
                    } catch (e) { alert("搜尋失敗，請檢查網路"); }
                    searchLoading.value = false;
                };

                const selectOSM = (res) => {
                    tempTrip.value.location = res.display_name.split(',')[0];
                    tempTrip.value.lat = parseFloat(res.lat);
                    tempTrip.value.lon = parseFloat(res.lon);
                    osmResults.value = [];
                };

                // 分帳邏輯 (核心演算法)
                const balances = computed(() => {
                    let b = {};
                    members.forEach(m => b[m] = 0);
                    expenses.value.forEach(e => {
                        const amt = e.currency === 'TWD' ? e.amount / e.rate : e.amount;
                        b[e.payer] += amt;
                        const share = amt / e.splitWith.length;
                        e.splitWith.forEach(m => b[m] -= share);
                    });
                    return b;
                });

                const settlements = computed(() => {
                    const b = { ...balances.value };
                    const debtors = [], creditors = [];
                    for (let m in b) {
                        if (b[m] < -0.01) debtors.push({ name: m, amount: Math.abs(b[m]) });
                        else if (b[m] > 0.01) creditors.push({ name: m, amount: b[m] });
                    }
                    
                    const result = [];
                    let i = 0, j = 0;
                    while (i < debtors.length && j < creditors.length) {
                        const payAmt = Math.min(debtors[i].amount, creditors[j].amount);
                        result.push({ from: debtors[i].name, to: creditors[j].name, amount: payAmt });
                        debtors[i].amount -= payAmt;
                        creditors[j].amount -= payAmt;
                        if (debtors[i].amount < 0.01) i++;
                        if (creditors[j].amount < 0.01) j++;
                    }
                    return result;
                });

                // Modal 管理
                const showTripModal = ref(false);
                const showExpModal = ref(false);
                const isEditing = ref(false);
                const isEditingExp = ref(false);
                const tempTrip = ref({});
                const tempExp = ref({});

                const openQuickAdd = () => {
                    if (activeTab.value === 'split') {
                        isEditingExp.value = false;
                        tempExp.value = { id: Date.now(), desc: '', amount: 0, currency: 'EUR', payer: '媽媽', splitWith: [...members], rate: exchangeRate.value };
                        showExpModal.value = true;
                    } else {
                        isEditing.value = false;
                        tempTrip.value = { id: Date.now(), date: selectedDate.value, time: '09:00', location: '', group: 'all' };
                        showTripModal.value = true;
                    }
                };

                const openEditModal = (item) => {
                    isEditing.value = true;
                    tempTrip.value = { ...item };
                    showTripModal.value = true;
                };

                const openEditExpense = (exp) => {
                    isEditingExp.value = true;
                    tempExp.value = { ...exp };
                    showExpModal.value = true;
                };

                const saveTrip = () => {
                    if (isEditing.value) {
                        const idx = schedule.value.findIndex(s => s.id === tempTrip.value.id);
                        schedule.value[idx] = { ...tempTrip.value };
                    } else {
                        schedule.value.push({ ...tempTrip.value });
                    }
                    showTripModal.value = false;
                };

                const deleteItem = () => {
                    schedule.value = schedule.value.filter(s => s.id !== tempTrip.value.id);
                    showTripModal.value = false;
                };

                const saveExpense = () => {
                    tempExp.value.date = selectedDate.value;
                    tempExp.value.rate = exchangeRate.value;
                    if (isEditingExp.value) {
                        const idx = expenses.value.findIndex(e => e.id === tempExp.value.id);
                        expenses.value[idx] = { ...tempExp.value };
                    } else {
                        expenses.value.push({ ...tempExp.value });
                    }
                    showExpModal.value = false;
                };

                const deleteExpense = () => {
                    expenses.value = expenses.value.filter(e => e.id !== tempExp.value.id);
                    showExpModal.value = false;
                };

                const filteredSchedule = computed(() => {
                    return schedule.value
                        .filter(i => i.date === selectedDate.value)
                        .filter(i => currentGroup.value === 'all' || i.group === currentGroup.value || i.group === 'all')
                        .sort((a, b) => a.time.localeCompare(b.time));
                });

                const formatDate = (d) => {
                    const parts = d.split('-');
                    return `${parts[1]}/${parts[2]}`;
                };

                return {
                    activeTab, currentGroup, selectedDate, dateRange, members,
                    schedule, filteredSchedule, expenses, balances, settlements,
                    showSettlement, exchangeRate, osmResults, searchLoading,
                    showTripModal, showExpModal, isEditing, isEditingExp, tempTrip, tempExp,
                    formatDate, openQuickAdd, openEditModal, saveTrip, deleteItem, searchOSM, selectOSM,
                    saveExpense, openEditExpense, deleteExpense
                };
            }
        }).mount('#app');
    </script>

    <style>
        @keyframes slide-up {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .animate-slide-up { animation: slide-up 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    </style>
</body>
</html>