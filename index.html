<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026家庭歐洲行 (修復版)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid transparent; }
        .calendar-cell.selected { background-color: #1e293b; color: white; }
        .has-expense::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background-color: #ef4444; border-radius: 50%; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full max-w-md mx-auto bg-slate-50 flex flex-col shadow-2xl relative text-slate-800">
    <div v-if="!isLoaded" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-800"></div>
    </div>

    <header class="bg-white/90 backdrop-blur-md px-5 py-4 shadow-sm z-20">
        <h1 class="text-xl font-extrabold text-slate-900">2026 家庭歐洲行</h1>
        <div class="text-xs text-slate-500 mt-1">{{ currentDay }} 行程預覽</div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24 no-scrollbar">
        <div v-show="activeTab === 'itinerary'">
            <div class="flex gap-2 p-4 overflow-x-auto no-scrollbar bg-white border-b">
                <button v-for="day in days" :key="day" @click="currentDay = day" :class="['px-4 py-2 rounded-xl text-sm font-bold flex-shrink-0', currentDay === day ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-400']">{{ day }}</button>
            </div>
            <div class="p-5 space-y-4">
                <div v-for="item in filteredItinerary" :key="item.id" class="bg-white p-4 rounded-2xl shadow-sm border-l-4" :class="item.group === 'A' ? 'border-teal-500' : (item.group === 'B' ? 'border-orange-500' : 'border-blue-500')">
                    <div class="text-xs font-bold text-slate-400 mb-1">{{ item.time }}</div>
                    <div class="font-bold text-slate-800">{{ item.location }}</div>
                </div>
            </div>
        </div>

        <div v-show="activeTab === 'expenses'" class="p-5 space-y-6">
            <div class="bg-slate-900 rounded-3xl p-6 text-white shadow-xl">
                <p class="text-slate-400 text-sm">總公費支出 (TWD)</p>
                <h2 class="text-3xl font-extrabold">${{ totalTWD.toLocaleString() }}</h2>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border p-4">
                <div class="flex justify-between mb-4 font-bold">
                    <button @click="changeMonth(-1)">◀</button>
                    <span>{{ calYear }} / {{ calMonth + 1 }}</span>
                    <button @click="changeMonth(1)">▶</button>
                </div>
                <div class="calendar-grid">
                    <div v-for="w in ['日','一','二','三','四','五','六']" class="text-xs text-slate-300">{{ w }}</div>
                    <div v-for="day in calendarDays" :key="day?.date" @click="day && (selDate = day.date)" :class="['calendar-cell', day && selDate === day.date ? 'selected' : '', day && day.hasExpense ? 'has-expense' : '']">
                        {{ day ? day.day : '' }}
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="font-bold text-slate-800">{{ selDate }} 明細</h3>
                <div v-for="exp in dailyExpenses" :key="exp.id" @click="openEditExpense(exp)" class="bg-white p-4 rounded-xl shadow-sm border flex justify-between">
                    <div>
                        <div class="font-bold text-sm">{{ exp.title }}</div>
                        <div class="text-[10px] text-slate-400">{{ exp.payer }} 代墊</div>
                    </div>
                    <div class="font-bold">${{ Math.round(exp.twdAmount) }}</div>
                </div>
            </div>
        </div>
    </main>

    <nav class="bg-white border-t p-3 flex justify-around safe-bottom absolute bottom-0 w-full">
        <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-slate-900' : 'text-slate-300'"><i data-lucide="calendar"></i></button>
        <button @click="activeTab = 'expenses'" :class="activeTab === 'expenses' ? 'text-slate-900' : 'text-slate-300'"><i data-lucide="wallet"></i></button>
    </nav>

    <div v-if="showExpModal" class="fixed inset-0 bg-black/50 z-[2000] flex items-end p-4">
        <div class="bg-white w-full rounded-3xl p-6">
            <div class="flex justify-between mb-4 font-bold text-lg">
                <span>{{ isEdit ? '編輯' : '新增' }}支出</span>
                <button @click="showExpModal = false">✕</button>
            </div>
            <div class="space-y-4">
                <input v-model="form.title" placeholder="項目" class="w-full p-3 bg-slate-50 rounded-xl outline-none">
                <input v-model.number="form.originalAmount" type="number" placeholder="金額" class="w-full p-3 bg-slate-50 rounded-xl outline-none">
                <div class="text-xs font-bold text-slate-400">分攤對象</div>
                <div class="grid grid-cols-3 gap-2">
                    <button v-for="m in members" @click="toggleM(m)" :class="['py-2 rounded-lg text-xs font-bold border', form.targetMembers.includes(m) ? 'bg-blue-500 text-white' : 'text-slate-400']">{{ m }}</button>
                </div>
                <button @click="saveExp" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold">儲存變更</button>
                <button v-if="isEdit" @click="delExp" class="w-full py-2 text-red-500 font-bold">刪除紀錄</button>
            </div>
        </div>
    </div>

    <button v-if="activeTab === 'expenses'" @click="openAddExp" class="fixed bottom-24 right-5 w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center z-30">＋</button>
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
        authDomain: "europetrip2026-d36f1.firebaseapp.com",
        databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
        projectId: "europetrip2026-d36f1",
        storageBucket: "europetrip2026-d36f1.firebasestorage.app",
        messagingSenderId: "368850353659",
        appId: "1:368850353659:web:8cc22ae3fcf13d11051f5e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const activeTab = ref('itinerary');
            const isLoaded = ref(false);
            const currentDay = ref('3/19');
            const selDate = ref(new Date().toISOString().split('T')[0]);
            const calDate = ref(new Date(2026, 2, 1));
            const members = ['媽媽', '佩琪', '錦盆', '恩琪', '一休'];
            const days = ['3/19', '3/20', '3/21', '3/22', '3/23'];
            const itinerary = ref([]);
            const expenses = ref([]);
            
            const showExpModal = ref(false);
            const isEdit = ref(false);
            const form = ref({ id: null, title: '', originalAmount: 0, payer: '媽媽', targetMembers: [], date: '' });

            const saveToCloud = () => set(dbRef(db, 'travel2026'), { itinerary: itinerary.value, expenses: expenses.value, days: days });

            const openAddExp = () => {
                isEdit.value = false;
                form.value = { id: Date.now(), title: '', originalAmount: 0, payer: '媽媽', targetMembers: [...members], date: selDate.value };
                showExpModal.value = true;
            };

            const openEditExpense = (exp) => {
                isEdit.value = true;
                form.value = JSON.parse(JSON.stringify(exp));
                showExpModal.value = true;
            };

            const toggleM = (m) => {
                const idx = form.value.targetMembers.indexOf(m);
                if(idx > -1) form.value.targetMembers.splice(idx, 1);
                else form.value.targetMembers.push(m);
            };

            const saveExp = () => {
                const rate = 34.5;
                const data = { ...form.value, twdAmount: form.value.originalAmount * rate };
                if(isEdit.value) {
                    const idx = expenses.value.findIndex(e => e.id === data.id);
                    expenses.value[idx] = data;
                } else {
                    expenses.value.push(data);
                }
                saveToCloud();
                showExpModal.value = false;
            };

            const delExp = () => {
                expenses.value = expenses.value.filter(e => e.id !== form.value.id);
                saveToCloud();
                showExpModal.value = false;
            };

            onMounted(() => {
                lucide.createIcons();
                onValue(dbRef(db, 'travel2026'), (snap) => {
                    const data = snap.val();
                    if(data) {
                        itinerary.value = data.itinerary || [];
                        expenses.value = data.expenses || [];
                    }
                    isLoaded.value = true;
                });
            });

            return {
                activeTab, isLoaded, currentDay, selDate, itinerary, expenses, days, members, showExpModal, isEdit, form,
                totalTWD: computed(() => expenses.value.reduce((s, e) => s + e.twdAmount, 0)),
                filteredItinerary: computed(() => itinerary.value.filter(i => i.day === currentDay.value).sort((a,b)=>a.time.localeCompare(b.time))),
                dailyExpenses: computed(() => expenses.value.filter(e => e.date === selDate.value)),
                calendarDays: computed(() => {
                    const year = calDate.value.getFullYear(), month = calDate.value.getMonth();
                    const first = new Date(year, month, 1).getDay(), last = new Date(year, month+1, 0).getDate();
                    let arr = [];
                    for(let i=0; i<first; i++) arr.push(null);
                    for(let i=1; i<=last; i++) {
                        const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                        arr.push({ day: i, date: dStr, hasExpense: expenses.value.some(e => e.date === dStr) });
                    }
                    return arr;
                }),
                calYear: computed(()=>calDate.value.getFullYear()),
                calMonth: computed(()=>calDate.value.getMonth()),
                changeMonth: (v) => calDate.value = new Date(calDate.value.setMonth(calDate.value.getMonth()+v)),
                openAddExp, openEditExpense, saveExp, delExp, toggleM
            };
        }
    }).mount('#app');
</script>
</body>
</html>
