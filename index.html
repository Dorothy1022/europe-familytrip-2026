<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026å®¶åº­æ­æ´²è¡Œ (åˆ†å¸³ç¯©é¸ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid transparent; }
        .calendar-cell:active { transform: scale(0.95); }
        .calendar-cell.has-expense::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background-color: #ef4444; border-radius: 50%; }
        .calendar-cell.selected { background-color: #1e293b; color: white; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); }
        .calendar-cell.selected.has-expense::after { background-color: #fff; }
        .calendar-cell.today { border-color: #3b82f6; color: #3b82f6; }

        .fade-slide-enter-active, .fade-slide-leave-active { transition: all 0.3s ease; max-height: 500px; opacity: 1; }
        .fade-slide-enter-from, .fade-slide-leave-to { max-height: 0; opacity: 0; margin-top: 0; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full max-w-md mx-auto bg-slate-50 flex flex-col shadow-2xl relative text-slate-800">

    <div v-if="!isLoaded" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-800 mb-3"></div>
        <p class="text-sm text-slate-500 font-bold tracking-wide">è¼‰å…¥æ—…ç¨‹ä¸­...</p>
    </div>

    <header class="bg-white/90 backdrop-blur-md px-5 py-4 shadow-sm z-20 sticky top-0 flex justify-between items-center">
        <div class="flex-1 mr-4">
            <h1 class="text-xl font-extrabold text-slate-900 leading-tight">2026 å®¶åº­æ­æ´²è¡Œ</h1>
            <input :value="dayTitles[getSafeKey(currentDay)]" @input="updateDayTitle" class="w-full bg-transparent text-sm text-slate-500 outline-none" :placeholder="currentDay + ' çš„ä¸»é¡Œæ˜¯ï¼Ÿ'">
        </div>
        <div class="text-right">
             <span class="px-2.5 py-1 bg-slate-100 text-slate-600 rounded-md text-xs font-bold">{{ activeTab === 'map' ? 'åœ°åœ–æ¨¡å¼' : currentDay }}</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24 no-scrollbar bg-slate-50">
        
        <div v-show="activeTab === 'itinerary'">
            <div class="sticky top-0 z-10 bg-slate-50/95 backdrop-blur-sm pt-3 pb-2 px-4 border-b border-slate-200 flex flex-col gap-3">
                <div class="flex gap-2 overflow-x-auto no-scrollbar items-center">
                    <button v-for="day in days" :key="day" @click="currentDay = day" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all', currentDay === day ? 'bg-slate-800 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200']">{{ day }}</button>
                </div>
                <div class="flex justify-center pb-1">
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-1 flex gap-1">
                        <button v-for="m in ['all', 'A', 'B']" @click="itineraryGroupMode = m" :class="['px-3 py-1.5 rounded-md text-[10px] font-bold transition-all', itineraryGroupMode === m ? (m === 'A' ? 'bg-teal-500 text-white' : (m === 'B' ? 'bg-orange-500 text-white' : 'bg-slate-800 text-white')) : 'text-slate-400']">{{ m === 'all' ? 'å…¨è¡Œç¨‹' : (m === 'A' ? 'è·è˜­çµ„' : 'ä¸‰å°åœ‹') }}</button>
                    </div>
                </div>
            </div>

            <div id="itinerary-list" class="px-5 py-6 space-y-5">
                <div v-for="(item, index) in filteredItinerary" :key="item.id" @click="openEditModal(item)" class="relative pl-6 cursor-pointer">
                    <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full border-[3px] border-slate-50 z-10" :class="getGroupColor(item.group)"></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4" :class="getGroupBorderLeft(item.group)">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-600">{{ item.time }}</span>
                            <span class="text-[10px] font-bold px-2 py-1 rounded-md text-white" :class="getGroupColor(item.group)">{{ getGroupName(item.group) }}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg">{{ item.location }}</h3>
                        <p v-if="item.note" class="text-xs text-slate-400 mt-1">{{ item.note }}</p>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fixed bottom-24 right-5 w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center z-30"><i data-lucide="plus"></i></button>
        </div>

        <div v-show="activeTab === 'expenses'" class="p-5 space-y-6">
            
            <div class="flex justify-center">
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-1.5 flex gap-1 w-full max-w-xs">
                    <button @click="expenseFilterMode = 'all'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition-all', expenseFilterMode === 'all' ? 'bg-slate-800 text-white' : 'text-slate-400']">å…¨éƒ¨</button>
                    <button @click="expenseFilterMode = 'A'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition-all', expenseFilterMode === 'A' ? 'bg-teal-500 text-white' : 'text-slate-400']">è·è˜­çµ„</button>
                    <button @click="expenseFilterMode = 'B'" :class="['flex-1 py-2 rounded-lg text-xs font-bold transition-all', expenseFilterMode === 'B' ? 'bg-orange-500 text-white' : 'text-slate-400']">ä¸‰å°åœ‹</button>
                </div>
            </div>

            <div @click="showAllExpenses = !showAllExpenses" class="bg-slate-900 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden cursor-pointer active:scale-[0.98] transition">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <p class="text-slate-400 text-sm mb-1 font-medium">{{ expenseFilterMode === 'all' ? 'ç¸½å…¬è²»æ”¯å‡º' : (expenseFilterMode === 'A' ? 'è·è˜­çµ„ç›¸é—œæ”¯å‡º' : 'ä¸‰å°åœ‹çµ„ç›¸é—œæ”¯å‡º') }} (TWD)</p>
                        <h2 class="text-3xl font-extrabold tracking-tight">${{ filteredTotalExpense.toLocaleString() }}</h2>
                    </div>
                    <div class="bg-white/20 p-2 rounded-full transition-transform duration-300" :class="showAllExpenses ? 'rotate-180' : ''">
                        <i data-lucide="chevron-down" class="w-5 h-5 text-white"></i>
                    </div>
                </div>
            </div>

            <transition name="fade-slide">
                <div v-if="showAllExpenses" class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden -mt-2 relative z-10">
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700 text-sm">ğŸ“œ ç¯©é¸å¸³ç›® ({{ sortedFilteredExpenses.length }}ç­†)</h3>
                    </div>
                    <div class="max-h-[50vh] overflow-y-auto p-4 space-y-3">
                         <div v-for="exp in sortedFilteredExpenses" :key="exp.id" @click="openEditExpenseModal(exp)" class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden flex justify-between items-center">
                            <div class="absolute left-0 top-0 bottom-0 w-1" :class="getGroupColor(exp.splitGroup || 'all')"></div>
                            <div class="pl-2">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">{{ exp.date }}</span>
                                    <span class="font-bold text-slate-800 text-sm">{{ exp.title }}</span>
                                </div>
                                <div class="text-[10px] text-slate-400">{{ exp.payer }} ä»˜ {{ exp.currency }} {{ exp.originalAmount }}</div>
                            </div>
                            <div class="font-mono font-bold text-slate-700 text-sm">${{ Math.round(exp.twdAmount).toLocaleString() }}</div>
                         </div>
                    </div>
                </div>
            </transition>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                <div class="flex justify-between items-center mb-4">
                    <button @click="changeMonth(-1)"><i data-lucide="chevron-left" class="w-5 h-5 text-slate-400"></i></button>
                    <h3 class="font-extrabold text-slate-800 text-lg">{{ currentCalendarYear }} å¹´ {{ currentCalendarMonth + 1 }} æœˆ</h3>
                    <button @click="changeMonth(1)"><i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="calendar-grid">
                    <div v-for="w in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" class="text-xs font-bold text-slate-300 py-2">{{ w }}</div>
                    <div v-for="(day, idx) in calendarDays" :key="idx" @click="day && selectExpenseDate(day.date)" :class="['calendar-cell', !day ? 'invisible' : '', day && day.date === selectedExpenseDate ? 'selected' : '', day && day.hasExpense ? 'has-expense' : '']">
                        <span v-if="day">{{ day.day }}</span>
                    </div>
                </div>
            </div>

            <div v-if="filteredDebts.length > 0" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <button @click="showSettlement = !showSettlement" class="w-full p-4 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-xs uppercase tracking-widest text-slate-400">{{ expenseFilterMode === 'all' ? 'å…¨é«”çµç®—å»ºè­°' : (expenseFilterMode === 'A' ? 'è·è˜­çµ„å…§éƒ¨çµç®—' : 'ä¸‰å°åœ‹å…§éƒ¨çµç®—') }}</h3>
                    <i :data-lucide="showSettlement ? 'chevron-up' : 'chevron-down'" class="w-4 h-4 text-slate-300"></i>
                </button>
                <div v-if="showSettlement" class="p-5 pt-2 space-y-2">
                    <div v-for="debt in filteredDebts" :key="debt.from+debt.to" class="flex justify-between items-center py-2 border-b border-slate-50 text-sm">
                        <span class="text-slate-600"><span class="bg-slate-100 px-2 py-0.5 rounded">{{ debt.from }}</span> â†’ <span class="bg-slate-100 px-2 py-0.5 rounded">{{ debt.to }}</span></span>
                        <span class="font-bold text-emerald-600 font-mono">NT$ {{ debt.amount.toLocaleString() }}</span>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="font-extrabold text-slate-800 text-lg mb-3">{{ formatDate(selectedExpenseDate) }} ç¯©é¸æ˜ç´°</h3>
                <div class="space-y-3 pb-10">
                    <div v-for="exp in filteredDailyExpenses" :key="exp.id" @click="openEditExpenseModal(exp)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center relative overflow-hidden">
                        <div class="absolute left-0 top-0 bottom-0 w-1" :class="getGroupColor(exp.splitGroup || 'all')"></div>
                        <div class="pl-2">
                            <p class="font-bold text-slate-800 text-sm">{{ exp.title }}</p>
                            <p class="text-[10px] text-slate-400 mt-1">{{ exp.payer }} ä»˜ {{ exp.currency }} {{ exp.originalAmount }}</p>
                        </div>
                        <p class="font-bold text-slate-800 font-mono text-sm">${{ Math.round(exp.twdAmount).toLocaleString() }}</p>
                    </div>
                </div>
            </div>
            <button @click="openAddExpenseModal" class="fixed bottom-24 right-5 w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center z-30"><i data-lucide="plus"></i></button>
        </div>

        <div v-show="activeTab === 'map'" class="h-full w-full relative">
            <div id="map" class="w-full h-full z-0"></div>
            <div class="absolute top-2 left-0 right-0 z-[1000] px-4 flex gap-2 overflow-x-auto no-scrollbar">
                 <button @click="setMapMode('all')" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold shadow-md transition-all', mapMode === 'all' ? 'bg-slate-800 text-white' : 'bg-white text-slate-500']">ğŸŒ å…¨è¦½</button>
                 <button v-for="day in days" :key="day" @click="setMapMode('single', day)" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold shadow-md transition-all', mapMode === 'single' && currentDay === day ? 'bg-blue-600 text-white' : 'bg-white text-slate-500']">{{ day }}</button>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t border-slate-100 px-6 py-2 flex justify-between items-center safe-bottom z-30">
        <button v-for="tab in ['itinerary', 'map', 'expenses']" @click="switchTab(tab)" :class="['flex flex-col items-center gap-1 py-1 px-4 rounded-xl', activeTab === tab ? 'text-slate-900 bg-slate-50' : 'text-slate-300']">
            <i :data-lucide="getIcon(tab)" class="w-6 h-6"></i><span class="text-[10px] font-bold capitalize">{{ getLabel(tab) }}</span>
        </button>
    </nav>

    <div v-if="showEditModal || showExpenseModal" class="fixed inset-0 bg-slate-900/40 z-[2000] flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <button @click="showEditModal = false; showExpenseModal = false" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold mt-4">é—œé–‰è¦–çª—</button>
        </div>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
        authDomain: "europetrip2026-d36f1.firebaseapp.com",
        databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
        projectId: "europetrip2026-d36f1",
        storageBucket: "europetrip2026-d36f1.firebasestorage.app",
        messagingSenderId: "368850353659",
        appId: "1:368850353659:web:8cc22ae3fcf13d11051f5e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const activeTab = ref('itinerary');
            const showEditModal = ref(false);
            const showExpenseModal = ref(false);
            const showAllExpenses = ref(false);
            const showSettlement = ref(false);
            const isLoaded = ref(false);
            
            const currentDay = ref('3/19');
            const itineraryGroupMode = ref('all');
            const expenseFilterMode = ref('all'); // æ–°å¢ï¼šåˆ†å¸³ç¯©é¸æ¨¡å¼
            const selectedExpenseDate = ref(new Date().toISOString().split('T')[0]);
            const calendarDate = ref(new Date(2026, 2, 1));

            const members = ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†', 'æ©çª', 'ä¸€ä¼‘'];
            const days = ref(['3/19', '3/20', '3/21', '3/22', '3/23']);
            const itineraryItems = ref([]);
            const expenses = ref([]);
            const dayTitles = ref({});

            const groupMembers = { all: members, A: ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†'], B: ['æ©çª', 'ä¸€ä¼‘'] };

            // --- ç¯©é¸èˆ‡è¨ˆç®—é‚è¼¯ ---

            // åˆ¤æ–·æŸç­†å¸³ç›®æ˜¯å¦è·Ÿç›®å‰é¸æ“‡çš„çµ„åˆ¥æœ‰é—œ
            const isRelatedToGroup = (exp, mode) => {
                if (mode === 'all') return true;
                const targetGroup = groupMembers[mode];
                const expTargets = exp.targetMembers || groupMembers[exp.splitGroup || 'all'];
                // åªè¦åˆ†æ”¤å°è±¡ä¸­æœ‰è©²çµ„åˆ¥çš„äººï¼Œå°±é¡¯ç¤º
                return expTargets.some(m => targetGroup.includes(m));
            };

            const sortedFilteredExpenses = computed(() => {
                return expenses.value
                    .filter(e => isRelatedToGroup(e, expenseFilterMode.value))
                    .sort((a, b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            });

            const filteredTotalExpense = computed(() => {
                return sortedFilteredExpenses.value.reduce((sum, e) => sum + e.twdAmount, 0);
            });

            const filteredDailyExpenses = computed(() => {
                return sortedFilteredExpenses.value.filter(e => e.date === selectedExpenseDate.value);
            });

            // é‡å°çµ„åˆ¥å…§éƒ¨è¨ˆç®—çµç®— (ä¾‹å¦‚åˆ‡åˆ°è·è˜­çµ„ï¼Œå°±åªç®—å¥¹å€‘ä¸‰äººçš„æ”¶æ”¯)
            const filteredBalanceList = computed(() => {
                const currentGroup = groupMembers[expenseFilterMode.value];
                let balances = {}; 
                currentGroup.forEach(m => balances[m] = 0);
                
                expenses.value.forEach(ex => {
                    const allTargets = ex.targetMembers || groupMembers[ex.splitGroup || 'all'];
                    // æ‰¾å‡ºè©²ç­†å¸³ç›®ä¸­ï¼Œå±¬æ–¼ç›®å‰é€™çµ„çš„äºº
                    const relatedInGroup = allTargets.filter(m => currentGroup.includes(m));
                    if (relatedInGroup.length === 0) return;

                    // æ¯äººåˆ†æ”¤é‡‘é¡ (ç¸½é¡ / ç¸½åˆ†æ”¤äººæ•¸)
                    const splitAmount = ex.twdAmount / allTargets.length;
                    
                    // å¦‚æœä»˜æ¬¾äººåœ¨é€™çµ„ï¼Œä»–æ”¶å›éŒ¢
                    if(currentGroup.includes(ex.payer)) balances[ex.payer] += ex.twdAmount;
                    
                    // é€™çµ„ä¸­çš„åƒèˆ‡è€…æ‰£æ‰åˆ†æ”¤é¡
                    relatedInGroup.forEach(m => balances[m] -= splitAmount);
                });
                return balances;
            });

            const filteredDebts = computed(() => {
                let balances = JSON.parse(JSON.stringify(filteredBalanceList.value));
                let result = [], debtors = Object.keys(balances).filter(k=>balances[k]<-1), creditors = Object.keys(balances).filter(k=>balances[k]>1);
                debtors.forEach(d => { creditors.forEach(c => {
                    if(balances[d] >= -1 || balances[c] <= 1) return;
                    let amount = Math.min(Math.abs(balances[d]), balances[c]);
                    if (Math.round(amount) > 0) {
                        result.push({from:d, to:c, amount: Math.round(amount)});
                        balances[d] += amount; balances[c] -= amount;
                    }
                })});
                return result;
            });

            // --- å…¶ä»–åŸºç¤åŠŸèƒ½ (çœç•¥é‡è¤‡é‚è¼¯ï¼Œèˆ‡èˆŠç‰ˆä¸€è‡´) ---
            const switchTab = (t) => activeTab.value = t;
            const getSafeKey = (d) => d.replace('/','_');
            const updateDayTitle = (e) => { dayTitles.value[getSafeKey(currentDay.value)] = e.target.value; saveToCloud(); };
            const saveToCloud = () => set(dbRef(db, 'travel2026'), { days: days.value, itinerary: itineraryItems.value, expenses: expenses.value, dayTitles: dayTitles.value });
            
            const filteredItinerary = computed(() => {
                let items = itineraryItems.value.filter(i => i.day === currentDay.value);
                if (itineraryGroupMode.value !== 'all') {
                    items = items.filter(i => i.group === 'all' || i.group === itineraryGroupMode.value);
                }
                return items.sort((a,b) => a.time.localeCompare(b.time));
            });

            onMounted(() => {
                lucide.createIcons();
                const dataRef = dbRef(db, 'travel2026');
                onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        itineraryItems.value = data.itinerary || [];
                        expenses.value = data.expenses || [];
                        dayTitles.value = data.dayTitles || {};
                    }
                    isLoaded.value = true;
                });
            });

            return {
                activeTab, isLoaded, currentDay, days, filteredItinerary, itineraryGroupMode,
                expenseFilterMode, sortedFilteredExpenses, filteredTotalExpense, filteredDailyExpenses,
                filteredDebts, showAllExpenses, showSettlement, selectedExpenseDate, dayTitles,
                switchTab, getSafeKey, updateDayTitle, 
                getGroupColor: (g) => ({all:'bg-blue-500', A:'bg-teal-500', B:'bg-orange-500'}[g]),
                getGroupBorderLeft: (g) => ({all:'border-l-blue-500', A:'border-l-teal-500', B:'border-l-orange-500'}[g]),
                getGroupName: (g) => ({all:'å…¨é«”', A:'è·è˜­çµ„', B:'ä¸‰å°åœ‹'}[g]),
                getIcon: (t) => ({itinerary:'calendar', map:'map', expenses:'wallet'}[t]),
                getLabel: (t) => ({itinerary:'è¡Œç¨‹', map:'åœ°åœ–', expenses:'åˆ†å¸³'}[t]),
                formatDate: (d) => d.split('-').slice(1).join('/')
            };
        }
    }).mount('#app');
</script>
</body>
</html>
