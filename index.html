<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å®¶åº­æ­æ´²è¡Œ - æœ€çµ‚é€²åŒ–ç‰ˆ</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 0.8rem; font-weight: 600; cursor: pointer; position: relative; }
        .calendar-cell.selected { background-color: #1e293b; color: white; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); }
        .calendar-cell.has-expense::after { content: ''; position: absolute; bottom: 4px; width: 3px; height: 3px; background-color: #ef4444; border-radius: 50%; }
        .calendar-cell.today { border: 1.5px solid #3b82f6; color: #3b82f6; }
        #map { height: 100%; width: 100%; z-index: 1; }
        .loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; gap: 10px; }
        .fade-slide-enter-active, .fade-slide-leave-active { transition: all 0.3s ease; max-height: 800px; opacity: 1; }
        .fade-slide-enter-from, .fade-slide-leave-to { max-height: 0; opacity: 0; }
        .glass-header { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full max-w-md mx-auto bg-slate-50 flex flex-col shadow-2xl relative text-slate-800">
    <div v-if="!isLoaded" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-900 mb-3"></div>
        <p class="text-xs font-bold text-slate-400">æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</p>
    </div>

    <header class="glass-header px-5 py-4 shadow-sm z-20 flex justify-between items-center shrink-0">
        <div class="flex-1 mr-4">
            <h1 class="text-xl font-black text-slate-900 tracking-tighter">2026 å®¶åº­æ­æ´²è¡Œ</h1>
            <input :value="dayTitles[getSafeKey(currentDay)]" @input="updateDayTitle" class="w-full bg-transparent text-[11px] font-bold text-slate-400 outline-none" :placeholder="currentDay + ' çš„ä¸»é¡Œæ˜¯ï¼Ÿ'">
        </div>
        <div class="text-right">
             <span class="px-2.5 py-1 bg-slate-900 text-white rounded-md text-[10px] font-black uppercase tracking-widest shadow-lg">{{ activeTab }}</span>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24 no-scrollbar bg-slate-50">
        
        <div v-show="activeTab === 'itinerary'">
            <div class="sticky top-0 z-30 glass-header border-b">
                <div class="flex gap-2 p-4 overflow-x-auto no-scrollbar items-center">
                    <button v-for="day in days" :key="day" @click="currentDay = day" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all', currentDay === day ? 'bg-slate-900 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-100']">{{ day }}</button>
                </div>
                <div class="flex justify-center pb-3">
                    <div class="bg-slate-100 p-1 rounded-lg flex gap-1">
                        <button v-for="m in ['all', 'A', 'B']" :key="m" @click="itineraryGroupMode = m" :class="['px-3 py-1.5 rounded-md text-[10px] font-bold transition-all', itineraryGroupMode === m ? 'bg-white shadow-sm text-slate-800' : 'text-slate-400']">{{ m === 'all' ? 'å…¨è¡Œç¨‹' : (m === 'A' ? 'è·è˜­çµ„' : 'ä¸‰å°åœ‹') }}</button>
                    </div>
                </div>
            </div>

            <div class="px-5 py-6 space-y-5">
                <div v-for="item in filteredItinerary" :key="item.id" @click="openEditModal(item)" class="relative pl-6 cursor-pointer group">
                    <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full border-[3px] border-slate-50 z-10 transition-transform group-active:scale-125" :class="getGroupColor(item.group)"></div>
                    <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4" :class="getGroupBorderLeft(item.group)">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[10px] font-bold text-slate-400">{{ item.time }}</span>
                            <span class="text-[10px] font-black px-2 py-0.5 rounded text-white" :class="getGroupColor(item.group)">{{ getGroupName(item.group) }}</span>
                        </div>
                        <h3 class="font-bold text-slate-800 text-lg leading-tight">{{ item.location }}</h3>
                        <p v-if="item.note" class="text-xs text-slate-400 mt-1">{{ item.note }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div v-show="activeTab === 'expenses'" class="p-5 space-y-6">
            
            <div class="flex justify-center">
                <div class="bg-slate-200 p-1 rounded-2xl flex gap-1 w-full max-w-xs shadow-inner">
                    <button v-for="g in ['all', 'A', 'B']" :key="g" @click="expenseFilterMode = g" :class="['flex-1 py-2.5 rounded-xl text-xs font-black transition-all', expenseFilterMode === g ? 'bg-white shadow-lg text-slate-900' : 'text-slate-400']">{{ g==='all'?'å…¨éƒ¨':(g==='A'?'è·è˜­çµ„':'ä¸‰å°åœ‹') }}</button>
                </div>
            </div>

            <div @click="showAllExpenses = !showAllExpenses" class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden active:scale-95 transition">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-blue-500/20 rounded-full blur-3xl"></div>
                <div class="relative z-10 flex justify-between items-end">
                    <div>
                        <p class="text-slate-400 text-xs font-black uppercase mb-1">{{ expenseFilterMode === 'all' ? 'ç¸½æ”¯å‡º' : (expenseFilterMode === 'A' ? 'è·è˜­çµ„ç›¸é—œ' : 'ä¸‰å°åœ‹çµ„ç›¸é—œ') }}</p>
                        <h2 class="text-4xl font-black italic tracking-tighter">${{ filteredTotalExpense.toLocaleString() }}</h2>
                    </div>
                    <div class="bg-white/20 p-2 rounded-full transition-transform" :class="showAllExpenses ? 'rotate-180' : ''">
                        <i data-lucide="chevron-down" class="w-5 h-5"></i>
                    </div>
                </div>
            </div>

            <transition name="fade-slide">
                <div v-if="showAllExpenses" class="bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden -mt-2 relative z-10">
                    <div class="max-h-[50vh] overflow-y-auto p-4 space-y-3">
                         <div v-for="exp in sortedFilteredExpenses" :key="exp.id" @click="openEditExpenseModal(exp)" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex justify-between items-center relative overflow-hidden active:bg-slate-50 transition">
                            <div class="absolute left-0 top-0 bottom-0 w-1" :class="getGroupColor(exp.splitGroup || 'all')"></div>
                            <div class="pl-2">
                                <div class="font-bold text-slate-800 text-sm">{{ exp.title }}</div>
                                <div class="text-[10px] text-slate-400">{{ exp.date }} Â· {{ exp.payer }}ä»£å¢Š</div>
                            </div>
                            <div class="font-black text-slate-700 text-sm">${{ Math.round(exp.twdAmount).toLocaleString() }}</div>
                         </div>
                    </div>
                </div>
            </transition>

            <div v-if="filteredDebts.length > 0" class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                <button @click="showSettlement = !showSettlement" class="w-full p-5 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest">çµç®—å»ºè­° ({{ expenseFilterMode === 'all' ? 'å…¨é«”' : (expenseFilterMode === 'A' ? 'è·è˜­' : 'ä¸‰å°åœ‹') }})</h3>
                    <i :data-lucide="showSettlement ? 'chevron-up' : 'chevron-down'" class="w-4 h-4 text-slate-300"></i>
                </button>
                <div v-if="showSettlement" class="p-5 space-y-3">
                    <div v-for="debt in filteredDebts" :key="debt.from+debt.to" class="flex justify-between items-center p-4 bg-white border border-slate-100 rounded-2xl shadow-sm">
                        <span class="text-xs font-bold text-slate-600"><span class="bg-slate-100 px-2 py-1 rounded-lg">{{ debt.from }}</span> â†’ <span class="bg-slate-100 px-2 py-1 rounded-lg">{{ debt.to }}</span></span>
                        <span class="font-black text-blue-600 font-mono">NT$ {{ debt.amount.toLocaleString() }}</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-100 p-5">
                <div class="flex justify-between items-center mb-6">
                    <button @click="changeMonth(-1)" class="p-2 hover:bg-slate-50 rounded-full"><i data-lucide="chevron-left" class="w-5 h-5 text-slate-400"></i></button>
                    <h3 class="font-black text-slate-800 text-lg">{{ currentCalendarYear }} å¹´ {{ currentCalendarMonth + 1 }} æœˆ</h3>
                    <button @click="changeMonth(1)" class="p-2 hover:bg-slate-50 rounded-full"><i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                <div class="calendar-grid">
                    <div v-for="w in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" class="text-[10px] font-black text-slate-300 py-1">{{ w }}</div>
                    <div v-for="(day, idx) in calendarDays" :key="idx" @click="day && selectExpenseDate(day.date)" :class="['calendar-cell', !day ? 'invisible' : '', day && day.date === selectedExpenseDate ? 'selected' : '', day && day.hasExpense ? 'has-expense' : '', day && day.isToday ? 'today' : '']">
                        <span v-if="day">{{ day.day }}</span>
                    </div>
                </div>
            </div>

            <div class="space-y-4 pb-12">
                <h3 class="font-black text-slate-800 text-xl tracking-tighter">{{ formatDate(selectedExpenseDate) }} æ˜ç´°</h3>
                <div v-if="filteredDailyExpenses.length === 0" class="text-center py-10 text-slate-300 font-bold">ç•¶å¤©ç„¡ç›¸é—œæ”¯å‡º</div>
                <div v-for="exp in filteredDailyExpenses" :key="exp.id" @click="openEditExpenseModal(exp)" class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 flex justify-between items-center relative overflow-hidden active:scale-[0.98] transition">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5" :class="getGroupColor(exp.splitGroup || 'all')"></div>
                    <div class="pl-2">
                        <p class="font-black text-slate-800 text-base tracking-tight">{{ exp.title }}</p>
                        <p class="text-[10px] text-slate-400 mt-1">ä»˜æ¬¾: {{ exp.payer }} / åˆ†æ”¤: {{ (exp.targetMembers || []).join(', ') }}</p>
                    </div>
                    <p class="font-black text-slate-900 text-lg tracking-tighter">${{ Math.round(exp.twdAmount).toLocaleString() }}</p>
                </div>
            </div>
        </div>

        <div v-show="activeTab === 'map'" class="h-full w-full relative">
            <div id="map" class="w-full h-full z-0"></div>
            <div class="absolute top-2 left-0 right-0 z-[1000] px-4 flex gap-2 overflow-x-auto no-scrollbar">
                 <button @click="setMapMode('all')" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold shadow-md', mapMode === 'all' ? 'bg-slate-800 text-white' : 'bg-white text-slate-500']">ğŸŒ å…¨è¦½</button>
                 <button v-for="day in days" :key="day" @click="setMapMode('single', day)" :class="['flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold shadow-md', mapMode === 'single' && currentDay === day ? 'bg-blue-600 text-white' : 'bg-white text-slate-500']">{{ day }}</button>
            </div>
        </div>
    </header>

    <nav class="bg-white/90 backdrop-blur-md border-t border-slate-100 p-4 flex justify-around safe-bottom absolute bottom-0 w-full z-40">
        <button v-for="tab in ['itinerary', 'map', 'expenses']" @click="switchTab(tab)" :class="['flex flex-col items-center gap-1 transition', activeTab === tab ? 'text-slate-900 scale-110' : 'text-slate-200']">
            <i :data-lucide="getIcon(tab)" class="w-6 h-6"></i>
            <span class="text-[10px] font-black uppercase">{{ getLabel(tab) }}</span>
        </button>
    </nav>

    <button v-if="activeTab !== 'map'" @click="activeTab==='itinerary'?openAddModal():openAddExpenseModal()" class="fixed bottom-24 right-6 w-16 h-16 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center z-30 active:scale-90 transition"><i data-lucide="plus" class="w-8 h-8"></i></button>

    <div v-if="showExpenseModal" class="fixed inset-0 bg-slate-900/60 z-[2000] flex items-end p-4 backdrop-blur-md">
        <div class="bg-white w-full rounded-[2.5rem] p-8 shadow-2xl overflow-y-auto max-h-[85vh] animate-in slide-in-from-bottom">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-slate-800">{{ isEditingExpense ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}</h3>
                <button @click="showExpenseModal = false" class="p-2 bg-slate-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <div class="space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">æ—¥æœŸ</label>
                    <input type="date" v-model="newExpense.date" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold">
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">é …ç›®åç¨±</label>
                    <input v-model="newExpense.title" placeholder="è¶…å¸‚æ¡è²·ã€é–€ç¥¨..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold">
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">é‡‘é¡</label>
                        <input v-model.number="newExpense.originalAmount" type="number" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-black text-xl">
                    </div>
                    <div class="w-28">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">å¹£åˆ¥</label>
                        <select v-model="newExpense.currency" class="w-full bg-slate-50 p-4 rounded-2xl font-black text-sm h-[60px]"><option value="EUR">EUR</option><option value="TWD">TWD</option></select>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between items-center mb-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">åˆ†æ”¤çµ¦èª°ï¼Ÿ (å¯è¤‡é¸)</label>
                        <div class="flex gap-1">
                            <button @click="quickSelect('all')" class="text-[8px] font-black bg-slate-100 px-2 py-1 rounded-md">å…¨é¸</button>
                            <button @click="quickSelect('A')" class="text-[8px] font-black bg-teal-50 text-teal-600 px-2 py-1 rounded-md">è·è˜­</button>
                            <button @click="quickSelect('B')" class="text-[8px] font-black bg-orange-50 text-orange-600 px-2 py-1 rounded-md">ä¸‰å°åœ‹</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button v-for="m in members" :key="m" @click="toggleMember(m)" :class="['py-3.5 rounded-2xl text-xs font-black transition-all border-2', newExpense.targetMembers.includes(m) ? 'bg-slate-900 text-white border-slate-900 shadow-lg' : 'text-slate-400 border-slate-50 bg-slate-50']">{{ m }}</button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3 block">ä»£å¢ŠéŒ¢çš„äºº</label>
                    <div class="flex gap-2 flex-wrap">
                        <button v-for="m in members" :key="m" @click="newExpense.payer = m" :class="['px-5 py-2.5 rounded-xl text-xs font-black border-2 transition-all', newExpense.payer === m ? 'bg-slate-900 text-white border-slate-900 shadow-md' : 'text-slate-400 border-slate-50 bg-slate-50']">{{ m }}</button>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button v-if="isEditingExpense" @click="deleteExpense" class="px-7 py-4 bg-red-50 text-red-500 rounded-2xl font-black transition active:scale-95"><i data-lucide="trash-2"></i></button>
                    <button @click="submitExpense" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-black text-lg shadow-xl active:scale-[0.98] transition">å„²å­˜æ”¯å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showEditModal" class="fixed inset-0 bg-slate-900/60 z-[2000] flex items-end p-4 backdrop-blur-sm">
        <div class="bg-white w-full rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom">
            <h3 class="text-2xl font-black text-slate-800 mb-6">ç·¨è¼¯è¡Œç¨‹</h3>
            <div class="space-y-4">
                <input v-model="editingItem.location" class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold">
                <div class="flex gap-3">
                    <input v-model="editingItem.time" type="time" class="flex-1 bg-slate-50 p-4 rounded-2xl font-bold">
                    <select v-model="editingItem.group" class="w-32 bg-slate-50 p-4 rounded-2xl font-bold"><option value="all">å…¨é«”</option><option value="A">è·è˜­çµ„</option><option value="B">ä¸‰å°åœ‹</option></select>
                </div>
                <textarea v-model="editingItem.note" class="w-full bg-slate-50 p-4 rounded-2xl outline-none text-sm" rows="3" placeholder="å‚™è¨»..."></textarea>
                <div class="flex gap-3 pt-4">
                    <button @click="deleteItem" class="px-7 py-4 bg-red-50 text-red-500 rounded-2xl font-black active:scale-95 transition"><i data-lucide="trash-2"></i></button>
                    <button @click="saveItem" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-black shadow-lg">æ›´æ–°è¡Œç¨‹</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
        authDomain: "europetrip2026-d36f1.firebaseapp.com",
        databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
        projectId: "europetrip2026-d36f1",
        storageBucket: "europetrip2026-d36f1.firebasestorage.app",
        messagingSenderId: "368850353659",
        appId: "1:368850353659:web:8cc22ae3fcf13d11051f5e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const activeTab = ref('itinerary');
            const showEditModal = ref(false);
            const showExpenseModal = ref(false);
            const showAllExpenses = ref(false);
            const showSettlement = ref(false);
            const isLoaded = ref(false);
            
            const currentDay = ref('3/19');
            const mapMode = ref('all');
            const itineraryGroupMode = ref('all');
            const expenseFilterMode = ref('all');
            const selectedExpenseDate = ref(new Date().toISOString().split('T')[0]);
            const calendarDate = ref(new Date(2026, 2, 1));

            const members = ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†', 'æ©çª', 'ä¸€ä¼‘'];
            const groups = { all: members, A: ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†'], B: ['æ©çª', 'ä¸€ä¼‘'] };
            
            // å®Œæ•´æ—¥æœŸ 3/19 - 4/4
            const days = ref([]);
            for(let d=19; d<=31; d++) days.value.push(`3/${d}`);
            for(let d=1; d<=4; d++) days.value.push(`4/${d}`);

            const itineraryItems = ref([]);
            const expenses = ref([]);
            const dayTitles = ref({});

            const newExpense = ref({ id: null, title: '', originalAmount: 0, currency: 'EUR', payer: 'åª½åª½', targetMembers: [], date: '' });
            const editingItem = ref({});

            let map = null, markers = L.layerGroup();

            const saveToCloud = () => {
                if(!isLoaded.value) return;
                set(dbRef(db, 'travel2026'), { days: days.value, itinerary: itineraryItems.value, expenses: expenses.value, dayTitles: dayTitles.value });
            };

            const switchTab = (t) => {
                activeTab.value = t;
                if(t === 'map') {
                    nextTick(() => {
                        if(!map) {
                            map = L.map('map', { zoomControl: false }).setView([52.3, 4.9], 10);
                            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                            markers.addTo(map);
                        }
                        map.invalidateSize();
                        updateMap();
                    });
                }
                nextTick(() => lucide.createIcons());
            };

            const updateMap = () => {
                markers.clearLayers();
                let pts = [];
                let items = mapMode.value === 'all' ? itineraryItems.value : itineraryItems.value.filter(i => i.day === currentDay.value);
                items.forEach(i => {
                    if(i.lat) {
                        const color = i.group==='A'?'#14b8a6':(i.group==='B'?'#f97316':'#3b82f6');
                        L.circleMarker([i.lat, i.lon], { color, radius: 6, fillOpacity: 0.8 }).addTo(markers).bindPopup(i.location);
                        pts.push([i.lat, i.lon]);
                    }
                });
                if(pts.length > 0 && map) map.fitBounds(pts, { padding: [50,50] });
            };

            // --- æ”¯å‡ºé‚è¼¯ (ä¿®å¾©æ ¸å¿ƒ) ---
            const toggleMember = (m) => {
                const idx = newExpense.value.targetMembers.indexOf(m);
                if(idx > -1) newExpense.value.targetMembers.splice(idx, 1);
                else newExpense.value.targetMembers.push(m);
            };

            const quickSelect = (type) => {
                if(type === 'all') newExpense.value.targetMembers = [...members];
                else if(type === 'A') newExpense.value.targetMembers = ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†'];
                else if(type === 'B') newExpense.value.targetMembers = ['æ©çª', 'ä¸€ä¼‘'];
            };

            const openAddExpenseModal = () => {
                newExpense.value = { id: Date.now(), title: '', originalAmount: '', currency: 'EUR', payer: 'åª½åª½', targetMembers: [...members], date: selectedExpenseDate.value };
                showExpenseModal.value = true;
                nextTick(() => lucide.createIcons());
            };

            const openEditExpenseModal = (exp) => {
                newExpense.value = JSON.parse(JSON.stringify(exp));
                if(!newExpense.value.targetMembers) newExpense.value.targetMembers = [...members];
                showExpenseModal.value = true;
                nextTick(() => lucide.createIcons());
            };

            const submitExpense = () => {
                if (!newExpense.value.title || !newExpense.value.originalAmount) return;
                const rate = newExpense.value.currency === 'TWD' ? 1 : 34.5;
                const data = { 
                    ...newExpense.value, 
                    twdAmount: newExpense.value.originalAmount * rate,
                    splitGroup: newExpense.value.targetMembers.length === 5 ? 'all' : 'custom'
                };
                
                const idx = expenses.value.findIndex(e => e.id === data.id);
                if (idx !== -1) expenses.value.splice(idx, 1, data); // ä¿®æ­£ï¼šå¼·åˆ¶æ›´æ–°é™£åˆ—
                else expenses.value.push(data);
                
                saveToCloud();
                showExpenseModal.value = false;
            };

            const deleteExpense = () => {
                expenses.value = expenses.value.filter(e => e.id !== newExpense.value.id);
                saveToCloud();
                showExpenseModal.value = false;
            };

            // --- è¡Œç¨‹é‚è¼¯ ---
            const openAddModal = () => { editingItem.value = { id: Date.now(), time: '10:00', location: '', group: 'all', note: '', day: currentDay.value }; showEditModal.value = true; };
            const openEditModal = (item) => { editingItem.value = JSON.parse(JSON.stringify(item)); showEditModal.value = true; };
            const saveItem = async () => {
                if(!editingItem.value.lat) {
                    try { const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${editingItem.value.location}`); const d = await r.json(); if(d.length) { editingItem.value.lat = d[0].lat; editingItem.value.lon = d[0].lon; } } catch(e) {}
                }
                const idx = itineraryItems.value.findIndex(i => i.id === editingItem.value.id);
                if(idx !== -1) itineraryItems.value.splice(idx, 1, editingItem.value);
                else itineraryItems.value.push(editingItem.value);
                saveToCloud(); showEditModal.value = false;
            };
            const deleteItem = () => { itineraryItems.value = itineraryItems.value.filter(i => i.id !== editingItem.value.id); saveToCloud(); showEditModal.value = false; };

            onMounted(() => {
                lucide.createIcons();
                onValue(dbRef(db, 'travel2026'), (snap) => {
                    const d = snap.val();
                    if(d) {
                        itineraryItems.value = d.itinerary || [];
                        expenses.value = d.expenses || [];
                        dayTitles.value = d.dayTitles || {};
                    }
                    isLoaded.value = true;
                });
            });

            // --- è¨ˆç®—å±¬æ€§ ---
            const sortedFilteredExpenses = computed(() => {
                return expenses.value.filter(e => {
                    if (expenseFilterMode.value === 'all') return true;
                    const targets = e.targetMembers || members;
                    return targets.some(m => groups[expenseFilterMode.value].includes(m));
                }).sort((a,b) => new Date(b.date) - new Date(a.date) || b.id - a.id);
            });

            const filteredTotalExpense = computed(() => sortedFilteredExpenses.value.reduce((s, e) => s + (e.twdAmount || 0), 0));
            
            const filteredDebts = computed(() => {
                const currentGroup = groups[expenseFilterMode.value];
                let balances = {}; currentGroup.forEach(m => balances[m] = 0);
                expenses.value.forEach(ex => {
                    const targets = ex.targetMembers || members;
                    const related = targets.filter(m => currentGroup.includes(m));
                    if (related.length === 0) return;
                    const per = ex.twdAmount / targets.length;
                    if(currentGroup.includes(ex.payer)) balances[ex.payer] += ex.twdAmount;
                    related.forEach(m => balances[m] -= per);
                });
                let res = [], dbs = Object.keys(balances).filter(k=>balances[k]<-1), crs = Object.keys(balances).filter(k=>balances[k]>1);
                dbs.forEach(d => { crs.forEach(c => {
                    if(balances[d] >= -1 || balances[c] <= 1) return;
                    let amt = Math.min(Math.abs(balances[d]), balances[c]);
                    if (Math.round(amt) > 0) { res.push({from:d, to:c, amount: Math.round(amt)}); balances[d] += amt; balances[c] -= amt; }
                })});
                return res;
            });

            return {
                activeTab, isLoaded, currentDay, mapMode, itineraryGroupMode, expenseFilterMode, selectedExpenseDate, itineraryItems, expenses, members, days, showExpenseModal, showAllExpenses, showSettlement, isEditingExpense: computed(()=>!!newExpense.value.id), newExpense, showEditModal, editingItem, dayTitles,
                filteredItinerary: computed(() => itineraryItems.value.filter(i => i.day === currentDay.value && (itineraryGroupMode.value === 'all' || i.group === 'all' || i.group === itineraryGroupMode.value)).sort((a,b)=>a.time.localeCompare(b.time))),
                sortedFilteredExpenses, filteredTotalExpense, filteredDailyExpenses: computed(() => sortedFilteredExpenses.value.filter(e => e.date === selectedExpenseDate.value)), filteredDebts,
                calendarDays: computed(() => {
                    const y = calDate.value.getFullYear(), m = calDate.value.getMonth();
                    const first = new Date(y, m, 1).getDay(), last = new Date(y, m + 1, 0).getDate();
                    let arr = []; for(let i=0; i<first; i++) arr.push(null);
                    for(let i=1; i<=last; i++) {
                        const dStr = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                        arr.push({ day: i, date: dStr, hasExpense: expenses.value.some(e => e.date === dStr), isToday: dStr === new Date().toISOString().split('T')[0] });
                    }
                    return arr;
                }),
                calYear: computed(()=>calDate.value.getFullYear()), calMonth: computed(()=>calDate.value.getMonth()),
                switchTab, openAddExpenseModal, openEditExpenseModal, toggleMember, quickSelect, submitExpense, deleteExpense, openAddModal, openEditModal, saveItem, deleteItem, changeMonth: (v) => calDate.value = new Date(calDate.value.setMonth(calDate.value.getMonth()+v)),
                getGroupColor: (g) => ({all:'bg-slate-900', A:'bg-teal-500', B:'bg-orange-500'}[g]),
                getGroupBorderLeft: (g) => ({all:'border-l-slate-900', A:'border-l-teal-500', B:'border-l-orange-500'}[g]),
                getGroupName: (g) => ({all:'å…¨é«”', A:'è·è˜­çµ„', B:'ä¸‰å°åœ‹'}[g]),
                getIcon: (t) => ({itinerary:'calendar', map:'map', expenses:'wallet'}[t]),
                getLabel: (t) => ({itinerary:'ITIN', map:'MAP', expenses:'CASH'}[t]),
                formatDate: (d) => d.split('-').slice(1).join('/'), getSafeKey, updateDayTitle: (e) => { dayTitles.value[getSafeKey(currentDay.value)] = e.target.value; saveToCloud(); },
                setMapMode: (m, d) => { mapMode.value = m; if(d) currentDay.value = d; updateMap(); }
            };
        }
    }).mount('#app');
</script>
</body>
</html>