<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 歐洲行最終版</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <style>
        /* 強制移除斜體，確保字體端正 */
        * { font-style: normal !important; -webkit-tap-highlight-color: transparent; }
        body { background-color: #f8fafc; font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        #map { height: 100%; width: 100%; z-index: 1; }
        
        /* 搜尋建議框 */
        .suggestion-box { position: absolute; top: 100%; left: 0; right: 0; background: white; z-index: 5000; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); border: 1px solid #eee; max-height: 200px; overflow-y: auto; }
        
        /* 底部導覽列 */
        .bottom-nav { background: white; border-top: 1px solid #eee; position: fixed; bottom: 0; width: 100%; max-width: 448px; display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; padding-bottom: calc(12px + env(safe-area-inset-bottom)); }
        .nav-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #cbd5e1; }
        .nav-btn.active { color: #1e293b; }

        /* 卡片選單 */
        .action-menu { position: absolute; top: 30px; right: 0; background: white; border: 1px solid #eee; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 500; min-width: 110px; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full max-w-md mx-auto bg-slate-50 flex flex-col relative shadow-2xl">
    
    <div v-if="!isLoaded" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-900"></div>
    </div>

    <header class="bg-white px-6 py-4 border-b shrink-0 z-20">
        <div class="flex justify-between items-center">
            <h1 class="text-xl font-black text-slate-900">2026 家庭歐洲行</h1>
            <button @click="location.reload()" class="text-slate-300">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
            </button>
        </div>
        <input :value="dayTitles[currentDay.replace('/','_')] || ''" @input="updateDayTitle" class="w-full bg-transparent text-xs font-bold text-slate-400 outline-none mt-1" :placeholder="currentDay + ' 的主題...'">
    </header>

    <main class="flex-1 overflow-y-auto no-scrollbar pb-32">
        <div v-show="activeTab === 'itinerary'">
            <div class="sticky top-0 bg-white border-b flex gap-2 p-4 overflow-x-auto no-scrollbar z-30">
                <button v-for="day in days" :key="day" @click="currentDay = day" :class="currentDay === day ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-400'" class="px-5 py-2 rounded-2xl text-xs font-bold flex-shrink-0">{{ day }}</button>
            </div>
            
            <div id="itin-list" class="p-5 space-y-4">
                <div v-for="item in filteredItinerary" :key="item.id" :data-id="item.id" class="bg-white p-5 rounded-[2rem] shadow-sm border-l-8 relative" :class="item.group === 'A' ? 'border-blue-500' : 'border-orange-500'">
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-bold text-slate-300">{{ item.time }}</span>
                        <div class="relative">
                            <button @click.stop="toggleMenu(item.id)" class="text-slate-200 font-bold px-2">•••</button>
                            <div v-if="activeMenuId === item.id" class="action-menu">
                                <button @click="openCopy(item)" class="w-full p-3 text-[11px] font-bold border-b text-left">複製行程</button>
                                <button @click="delItin(item.id)" class="w-full p-3 text-[11px] font-bold text-red-500 text-left">刪除行程</button>
                            </div>
                        </div>
                    </div>
                    <div @click="openEditItem(item)" class="font-bold text-lg text-slate-800">{{ item.location }}</div>
                    <div v-if="item.note" class="text-[10px] text-slate-400 mt-2">{{ item.note }}</div>
                </div>
            </div>
        </div>

        <div v-show="activeTab === 'map'" class="h-full relative"><div id="map"></div></div>

        <div v-show="activeTab === 'expenses'" class="p-5 space-y-6">
            <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <p class="text-slate-400 text-[10px] font-bold uppercase mb-1">總支出 (TWD)</p>
                <h2 class="text-4xl font-black tracking-tighter">${{ Math.round(totalTWD).toLocaleString() }}</h2>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div v-for="m in members" :key="m" class="bg-white p-5 rounded-[2rem] border shadow-sm">
                    <div class="text-[10px] font-bold text-slate-300 mb-1">{{ m }}</div>
                    <div class="text-xl font-bold tracking-tighter" :class="getBalance(m) >= 0 ? 'text-blue-600' : 'text-orange-500'">
                        {{ getBalance(m) >= 0 ? '+' : '' }}{{ Math.round(getBalance(m)).toLocaleString() }}
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] p-6 border">
                <div class="flex justify-between font-bold mb-4">
                    <button @click="changeMonth(-1)">←</button>
                    <span>{{ calYear }} / {{ calMonth + 1 }}</span>
                    <button @click="changeMonth(1)">→</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center">
                    <div v-for="w in ['日','一','二','三','四','五','六']" :key="w" class="text-[10px] text-slate-300 font-bold pb-2">{{ w }}</div>
                    <div v-for="(day, idx) in calendarDays" :key="idx" @click="day && (selDate = day.date)" :class="day && selDate === day.date ? 'bg-slate-900 text-white' : 'text-slate-400'" class="aspect-square flex items-center justify-center text-xs font-bold rounded-lg">
                        {{ day ? day.day : '' }}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button v-if="activeTab !== 'map'" @click="activeTab === 'expenses' ? openAddExp() : openAddItin()" class="fixed bottom-24 right-6 w-14 h-14 bg-slate-900 text-white rounded-full shadow-2xl flex items-center justify-center font-bold text-2xl z-50">+</button>

    <nav class="bottom-nav">
        <button v-for="t in [ {id:'itinerary', label:'行程', path:'M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'}, {id:'map', label:'地圖', path:'M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7'}, {id:'expenses', label:'分帳', path:'M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z'} ]" :key="t.id" @click="switchTab(t.id)" :class="{active: activeTab === t.id}" class="nav-btn">
            <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path :d="t.path"></path></svg>
            <span class="text-[9px] font-bold">{{ t.label }}</span>
        </button>
    </nav>

    <div v-if="showItinModal" class="fixed inset-0 bg-black/60 z-[2000] flex items-end p-4 backdrop-blur-sm">
        <div class="bg-white w-full rounded-[2.5rem] p-8 max-h-[90vh] flex flex-col relative shadow-2xl">
            <h3 class="text-xl font-bold mb-6">{{ isEdit ? '修改行程' : '新增行程' }}</h3>
            <div class="flex-1 overflow-y-auto space-y-5 pb-6">
                <div class="flex gap-2">
                    <button v-for="c in ['景點','住宿','班機']" :key="c" @click="itinForm.category = c" :class="itinForm.category === c ? 'bg-slate-900 text-white' : 'bg-slate-50 text-slate-400'" class="flex-1 py-3 rounded-xl text-xs font-bold">{{ c }}</button>
                </div>
                <div class="relative">
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">地點名稱</label>
                    <input v-model="itinForm.location" @input="fetchSuggestions" placeholder="搜尋景點..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold">
                    <div v-if="suggestions.length" class="suggestion-box">
                        <div v-for="s in suggestions" :key="s.place_id" @click="selectSuggestion(s)" class="p-4 border-b border-slate-50 hover:bg-slate-50 cursor-pointer font-bold text-xs">{{ s.display_name.split(',')[0] }}</div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">時間</label>
                        <input v-model="itinForm.time" type="time" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none border-none">
                    </div>
                    <div class="w-32">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">組別</label>
                        <select v-model="itinForm.group" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none appearance-none text-center border-none"><option value="all">全體</option><option value="A">荷蘭</option><option value="B">三小國</option></select>
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 block mb-1">備註區</label>
                    <textarea v-model="itinForm.note" rows="3" placeholder="例如：門票已預約、必吃..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none font-bold text-sm resize-none"></textarea>
                </div>
            </div>
            <div class="flex gap-3 pt-4 border-t">
                <button @click="showItinModal = false" class="flex-1 py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold">取消</button>
                <button @click="saveItin" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold">儲存行程</button>
            </div>
        </div>
    </div>

    <div v-if="showExpModal" class="fixed inset-0 bg-black/60 z-[2000] flex items-end p-4 backdrop-blur-sm">
        <div class="bg-white w-full rounded-[3rem] p-8 max-h-[90vh] flex flex-col shadow-2xl">
            <h3 class="text-xl font-bold mb-6">新增帳目</h3>
            <div class="flex-1 overflow-y-auto space-y-6 pb-6">
                <input v-model="expForm.title" placeholder="項目名稱" class="w-full bg-slate-50 p-4 rounded-2xl font-bold text-lg outline-none">
                
                <div class="flex gap-3">
                    <div class="flex-1">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">金額 ({{ expForm.currency }})</label>
                        <input v-model.number="expForm.amount" type="number" class="w-full bg-slate-50 p-4 rounded-2xl font-black text-2xl outline-none border-none">
                    </div>
                    <div class="w-24">
                        <label class="text-[10px] font-bold text-slate-400 block mb-1">幣別</label>
                        <select v-model="expForm.currency" class="w-full bg-slate-50 p-4 rounded-2xl font-bold outline-none border-none"><option value="EUR">EUR</option><option value="TWD">TWD</option></select>
                    </div>
                </div>

                <div v-if="expForm.currency === 'EUR'" class="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex justify-between items-center">
                    <span class="text-[11px] font-bold text-slate-400">匯率調整 (1 EUR = ? TWD)</span>
                    <input v-model.number="expForm.rate" type="number" step="0.1" class="w-20 bg-white border border-slate-200 rounded-lg p-1 text-center font-bold text-blue-600 outline-none">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 block mb-3">誰付的錢？ (單選)</label>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <button v-for="m in members" :key="m" @click="expForm.payer = m" :class="expForm.payer === m ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-400'" class="px-5 py-2 rounded-xl text-xs font-bold flex-shrink-0 transition-all">{{ m }}</button>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 block mb-3">分攤成員 (複選)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <button v-for="m in members" :key="m" @click="toggleTarget(m)" :class="expForm.targets.includes(m) ? 'bg-slate-900 text-white shadow-md' : 'bg-slate-100 text-slate-400'" class="py-3.5 rounded-2xl text-xs font-bold transition-all">{{ m }}</button>
                    </div>
                </div>
            </div>
            <div class="flex gap-3 pt-4 border-t">
                <button @click="showExpModal = false" class="flex-1 py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold">取消</button>
                <button @click="saveExp" class="flex-1 py-4 bg-slate-900 text-white rounded-2xl font-bold shadow-lg">儲存帳目</button>
            </div>
        </div>
    </div>

    <div v-if="showCopySelector" class="fixed inset-0 bg-black/80 z-[3000] flex items-center justify-center p-6 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 flex flex-col shadow-2xl">
            <h3 class="text-center font-bold text-xl mb-6">要複製到哪一天？</h3>
            <div class="max-h-[50vh] overflow-y-auto no-scrollbar space-y-2">
                <button v-for="day in days" :key="day" @click="confirmCopy(day)" class="w-full py-4 rounded-2xl font-bold text-sm bg-slate-50 active:bg-slate-900 active:text-white transition-all">{{ day }}</button>
            </div>
            <button @click="showCopySelector = false" class="mt-6 w-full py-4 text-slate-400 font-bold">取消操作</button>
        </div>
    </div>
</div>

<script type="module">
    import { createApp, ref, computed, onMounted, nextTick } from 'https://unpkg.com/vue@3/dist/vue.global.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const fb = initializeApp({
        apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
        databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
        projectId: "europetrip2026-d36f1"
    });
    const db = getDatabase(fb);

    createApp({
        setup() {
            const isLoaded = ref(false);
            const activeTab = ref('itinerary');
            const currentDay = ref('3/19');
            const selDate = ref('2026-03-19');
            const calDate = ref(new Date(2026, 2, 1));
            const members = ['媽媽', '佩琪', '錦盆', '恩琪', '一休'];
            const days = [];
            for(let d=19; d<=31; d++) days.push(`3/${d}`);
            for(let d=1; d<=4; d++) days.push(`4/${d}`);

            const itinerary = ref([]);
            const expenses = ref([]);
            const dayTitles = ref({});
            const showItinModal = ref(false);
            const showExpModal = ref(false);
            const showCopySelector = ref(false);
            const activeMenuId = ref(null);
            const isEdit = ref(false);
            const itinForm = ref({});
            const expForm = ref({});
            const suggestions = ref([]);
            const copySource = ref(null);

            const sync = () => {
                if(!isLoaded.value) return;
                set(dbRef(db, 'travel2026'), { 
                    itinerary: JSON.parse(JSON.stringify(itinerary.value)), 
                    expenses: JSON.parse(JSON.stringify(expenses.value)), 
                    dayTitles: dayTitles.value 
                });
            };

            onMounted(() => {
                // 強制解鎖！如果 Firebase 連線慢，0.5秒後也會強行關閉轉圈圈
                setTimeout(() => { if(!isLoaded.value) isLoaded.value = true; }, 500);

                onValue(dbRef(db, 'travel2026'), (snap) => {
                    const d = snap.val() || {};
                    itinerary.value = Array.isArray(d.itinerary) ? d.itinerary : Object.values(d.itinerary || {});
                    expenses.value = Array.isArray(d.expenses) ? d.expenses : Object.values(d.expenses || {});
                    dayTitles.value = d.dayTitles || {};
                    isLoaded.value = true;
                    nextTick(() => initSortable());
                });
            });

            const initSortable = () => {
                const el = document.getElementById('itin-list');
                if(!el) return;
                Sortable.create(el, {
                    animation: 200, delay: 400, delayOnTouchOnly: true,
                    onEnd: (evt) => {
                        const list = itinerary.value.filter(i => i.day === currentDay.value).sort((a,b)=>a.time.localeCompare(b.time));
                        const [moved] = list.splice(evt.oldIndex, 1);
                        list.splice(evt.newIndex, 0, moved);
                        sync();
                    }
                });
            };

            const fetchSuggestions = async () => {
                if (itinForm.value.location.length < 2) return;
                try {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${itinForm.value.location}&limit=5`);
                    suggestions.value = await r.json();
                } catch(e) {}
            };
            const selectSuggestion = (s) => {
                itinForm.value.location = s.display_name.split(',')[0];
                itinForm.value.lat = s.lat; itinForm.value.lon = s.lon;
                suggestions.value = [];
                if(window.mapInstance) window.mapInstance.flyTo([s.lat, s.lon], 15);
            };

            const openAddItin = () => { isEdit.value = false; itinForm.value = { id: Date.now(), location: '', time: '10:00', group: 'all', category: '景點', day: currentDay.value, note: '' }; showItinModal.value = true; };
            const openEditItem = (item) => { isEdit.value = true; itinForm.value = JSON.parse(JSON.stringify(item)); showItinModal.value = true; };
            const saveItin = () => {
                const idx = itinerary.value.findIndex(i => i.id === itinForm.value.id);
                if(idx > -1) itinerary.value[idx] = itinForm.value; else itinerary.value.push(itinForm.value);
                sync(); showItinModal.value = false;
            };

            const toggleMenu = (id) => activeMenuId.value = activeMenuId.value === id ? null : id;
            const delItin = (id) => { itinerary.value = itinerary.value.filter(i => i.id !== id); sync(); activeMenuId.value = null; };
            const openCopy = (item) => { copySource.value = item; showCopySelector.value = true; activeMenuId.value = null; };
            const confirmCopy = (day) => { itinerary.value.push({...copySource.value, id: Date.now(), day}); sync(); showCopySelector.value = false; };

            const openAddExp = () => { expForm.value = { id: Date.now(), title: '', amount: 0, currency: 'EUR', rate: 37, payer: '媽媽', targets: [...members], date: selDate.value }; showExpModal.value = true; };
            const toggleTarget = (m) => {
                const i = expForm.value.targets.indexOf(m);
                if(i > -1) expForm.value.targets.splice(i, 1); else expForm.value.targets.push(m);
            };
            const saveExp = () => {
                const multi = expForm.value.currency === 'EUR' ? expForm.value.rate : 1;
                expForm.value.twdAmount = expForm.value.amount * multi;
                expenses.value.push(expForm.value);
                sync(); showExpModal.value = false;
            };

            let mapInstance = null, markerLayer = L.layerGroup();
            const switchTab = (tab) => {
                activeTab.value = tab;
                if(tab === 'map') {
                    nextTick(() => {
                        if(!window.mapInstance) {
                            window.mapInstance = L.map('map', { zoomControl: false }).setView([52.3, 4.9], 12);
                            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(window.mapInstance);
                            markerLayer.addTo(window.mapInstance);
                        }
                        window.mapInstance.invalidateSize();
                        markerLayer.clearLayers();
                        itinerary.value.forEach(i => { if(i.lat) L.circleMarker([i.lat, i.lon], { color: i.group==='A'?'#3b82f6':'#f97316', radius: 8 }).addTo(markerLayer); });
                    });
                }
            };

            return {
                isLoaded, activeTab, currentDay, selDate, itinerary, expenses, members, days, showItinModal, showExpModal, showCopySelector, isEdit, itinForm, expForm, dayTitles, suggestions, activeMenuId,
                calYear: computed(() => calDate.value.getFullYear()), calMonth: computed(() => calDate.value.getMonth()),
                filteredItinerary: computed(() => itinerary.value.filter(i => i.day === currentDay.value).sort((a,b)=>a.time.localeCompare(b.time))),
                totalTWD: computed(() => expenses.value.reduce((s, e) => s + (e.twdAmount || 0), 0)),
                getBalance: (m) => {
                    let b = 0;
                    expenses.value.forEach(e => {
                        const tgts = e.targets || [];
                        if(e.payer === m) b += (e.twdAmount - (e.twdAmount / (tgts.length || 1)));
                        else if(tgts.includes(m)) b -= (e.twdAmount / (tgts.length || 1));
                    });
                    return b;
                },
                calendarDays: computed(() => {
                    const y = calDate.value.getFullYear(), m = calDate.value.getMonth();
                    const first = new Date(y, m, 1).getDay(), last = new Date(y, m+1, 0).getDate();
                    let arr = []; for(let i=0; i<first; i++) arr.push(null);
                    for(let i=1; i<=last; i++) arr.push({ day: i, date: `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}` });
                    return arr;
                }),
                switchTab, openAddItin, openEditItem, saveItin, delItin, toggleMenu, openCopy, confirmCopy, openAddExp, toggleTarget, saveExp, fetchSuggestions, selectSuggestion,
                changeMonth: (v) => calDate.value = new Date(calDate.value.setMonth(calDate.value.getMonth()+v)),
                updateDayTitle: (e) => { dayTitles.value[currentDay.value.replace('/','_')] = e.target.value; sync(); }
            };
        }
    }).mount('#app');
</script>
</body>
</html>