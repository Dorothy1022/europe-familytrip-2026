<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026å®¶åº­æ­æ´²è¡Œ (æœˆæ›†è¨˜å¸³ç‰ˆ)</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <style>
        /* åŸºç¤è¨­ç½® */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        
        /* æœå°‹å»ºè­°åˆ—è¡¨ */
        .suggestions-list {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e2e8f0;
            border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            z-index: 60; max-height: 200px; overflow-y: auto; margin-top: 6px;
        }
        .suggestion-item { padding: 12px 14px; font-size: 0.9rem; cursor: pointer; border-bottom: 1px solid #f1f5f9; transition: background 0.2s; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: #f1f5f9; }

        /* Leaflet åœ°åœ–æ¨£å¼ */
        .leaflet-popup-content-wrapper { border-radius: 12px; padding: 0; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .leaflet-popup-content { margin: 0; width: 100% !important; }
        .custom-marker { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .custom-marker:hover { transform: scale(1.2); z-index: 1000 !important; }

        /* é¸å–®å‹•ç•« */
        .menu-enter-active, .menu-leave-active { transition: all 0.2s ease; }
        .menu-enter-from, .menu-leave-to { opacity: 0; transform: translateY(-10px) scale(0.95); }
        
        /* æœˆæ›†æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; }
        .calendar-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; position: relative; border: 1px solid transparent; }
        .calendar-cell:active { transform: scale(0.95); }
        .calendar-cell.has-expense::after { content: ''; position: absolute; bottom: 6px; width: 4px; height: 4px; background-color: #ef4444; border-radius: 50%; }
        .calendar-cell.selected { background-color: #1e293b; color: white; box-shadow: 0 4px 10px rgba(30, 41, 59, 0.3); }
        .calendar-cell.selected.has-expense::after { background-color: #fff; }
        .calendar-cell.today { border-color: #3b82f6; color: #3b82f6; }
        .calendar-cell.today.selected { border-color: transparent; color: white; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-full max-w-md mx-auto bg-slate-50 flex flex-col shadow-2xl relative text-slate-800">

    <div v-if="!isLoaded" class="loading-overlay">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-800 mb-3"></div>
        <p class="text-sm text-slate-500 font-bold tracking-wide">è¼‰å…¥æ—…ç¨‹ä¸­...</p>
    </div>

    <header class="bg-white/90 backdrop-blur-md px-5 py-4 shadow-sm z-20 sticky top-0 flex justify-between items-center transition-all">
        <div class="flex-1 mr-4">
            <h1 class="text-xl font-extrabold text-slate-900 leading-tight tracking-tight">2026 å®¶åº­æ­æ´²è¡Œ</h1>
            <input 
                :value="dayTitles[getSafeKey(currentDay)]" 
                @input="updateDayTitle"
                class="subtitle-input w-full bg-transparent border-b border-transparent hover:border-slate-200 focus:border-slate-400 text-sm text-slate-500 font-medium placeholder-slate-300 mt-1 outline-none transition-colors" 
                :placeholder="currentDay + ' çš„ä¸»é¡Œæ˜¯ï¼Ÿ (é»æ“Šè¼¸å…¥)'"
            >
        </div>
        <div class="flex flex-col items-end gap-1.5">
             <div class="flex gap-2 items-center">
                 <div class="flex items-center gap-1 bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold shadow-sm">
                    <span class="relative flex h-1.5 w-1.5">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                    </span>
                    Live
                 </div>
                 <span class="px-2.5 py-1 bg-slate-100 text-slate-600 rounded-md text-xs font-bold">{{ mapMode === 'all' && activeTab === 'map' ? 'å…¨è¦½æ¨¡å¼' : currentDay }}</span>
             </div>
             <div v-if="weatherInfo" class="text-[10px] text-slate-400 flex items-center gap-1 font-medium bg-slate-50 px-2 py-0.5 rounded-full">
                 <i data-lucide="thermometer" class="w-3 h-3 text-slate-400"></i> {{ weatherInfo }}
             </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto pb-24 scroll-smooth no-scrollbar bg-slate-50 relative">
        
        <div v-show="activeTab === 'itinerary'" class="min-h-full">
            <div class="sticky top-0 z-10 bg-slate-50/95 backdrop-blur-sm pt-3 pb-4 px-4 border-b border-slate-200">
                <div class="flex gap-2 overflow-x-auto no-scrollbar snap-x items-center pl-1">
                    <button v-for="(day, idx) in days" :key="idx" @click="currentDay = day" @dblclick="editDayName(idx)"
                        :class="['snap-center flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all transform duration-200', currentDay === day ? 'bg-slate-800 text-white shadow-md scale-100' : 'bg-white text-slate-400 border border-slate-200 active:scale-95']">
                        {{ day }}
                    </button>
                    <div class="w-px h-6 bg-slate-200 mx-1 flex-shrink-0"></div>
                    <button @click="addDay" class="flex-shrink-0 w-9 h-9 rounded-full bg-white border border-slate-200 text-blue-500 flex items-center justify-center active:bg-blue-50 transition shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                    </button>
                    <button @click="removeDay" class="flex-shrink-0 w-9 h-9 rounded-full bg-white border border-slate-200 text-red-400 flex items-center justify-center active:bg-red-50 transition shadow-sm">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

            <div id="itinerary-list" class="px-5 py-6 space-y-5 min-h-[300px]">
                <div v-if="filteredItinerary.length === 0" class="text-center py-16 text-slate-300 no-sort flex flex-col items-center">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mb-3 text-slate-300"><i data-lucide="calendar" class="w-8 h-8"></i></div>
                    <p class="font-bold">æœ¬æ—¥ç„¡è¡Œç¨‹</p>
                    <p class="text-xs mt-1">é»æ“Šå³ä¸‹è§’ + é–‹å§‹è¦åŠƒ</p>
                </div>
                <div v-for="(item, index) in filteredItinerary" :key="item.id" :data-id="item.id" class="itinerary-item relative group">
                    <div v-if="index > 0 && item.travelTime" class="absolute -top-[22px] left-0 right-0 flex justify-center z-0">
                         <div class="bg-slate-100 px-3 py-0.5 rounded-full text-[10px] text-slate-400 flex items-center gap-1 border border-slate-200 font-mono shadow-sm"><i data-lucide="car" class="w-3 h-3"></i> {{ item.travelTime }}</div>
                    </div>
                    <div v-if="index < filteredItinerary.length - 1" class="absolute top-10 bottom-[-20px] left-[27px] w-0.5 bg-slate-200 -z-10"></div>
                    <div class="relative pl-6 cursor-pointer select-none" @click="openEditModal(item)">
                        <div class="absolute -left-[9px] top-4 w-4 h-4 rounded-full border-[3px] border-slate-50 z-10 shadow-sm" :class="getGroupColor(item.group)"></div>
                        <div class="bg-white p-4 rounded-2xl shadow-[0_2px_8px_rgba(0,0,0,0.04)] relative overflow-hidden border-l-4 transition active:scale-[0.98] border-slate-100" :class="getGroupBorderLeft(item.group)">
                            <div class="flex justify-between items-start mb-1.5">
                                <div class="flex flex-wrap gap-2 items-center">
                                    <span class="text-xs font-bold px-2 py-1 rounded-md bg-slate-100 text-slate-600 font-mono tracking-tight">{{ item.time }}</span>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-md text-white flex items-center gap-1 shadow-sm" :class="getGroupColor(item.group)">
                                        <i data-lucide="plane" class="w-3 h-3" v-if="item.type === 'flight'"></i>
                                        <i data-lucide="bed-double" class="w-3 h-3" v-else-if="item.type === 'accommodation'"></i>
                                        <i data-lucide="users" class="w-3 h-3" v-else-if="item.group === 'all'"></i>
                                        <i data-lucide="user" class="w-3 h-3" v-else></i>
                                        <span>{{ getGroupName(item.group) }}</span>
                                    </span>
                                </div>
                                <i data-lucide="grip-vertical" class="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition"></i>
                            </div>
                            <h3 class="font-bold text-slate-800 text-lg leading-snug">{{ item.location }}</h3>
                            <div class="flex flex-wrap gap-2 mt-2.5">
                                <span v-if="item.duration" class="text-[10px] bg-orange-50 text-orange-600 px-2 py-0.5 rounded-md font-bold flex items-center gap-1 border border-orange-100"><i data-lucide="clock" class="w-3 h-3"></i> {{ item.duration }}</span>
                                <p v-if="item.note" class="text-xs text-slate-400 line-clamp-1 flex-1 pt-0.5">{{ item.note }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button @click="openAddModal" class="fixed bottom-24 right-5 w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-transform z-30 hover:bg-slate-800"><i data-lucide="plus" class="w-7 h-7"></i></button>
        </div>

        <div v-show="activeTab === 'expenses'" class="p-5 space-y-6">
            <div class="bg-slate-900 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-2xl"></div>
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-slate-400 text-sm mb-1 font-medium">ç¸½å…¬è²»æ”¯å‡º (TWD)</p>
                        <h2 class="text-3xl font-extrabold tracking-tight">${{ totalExpenseTWD.toLocaleString() }}</h2>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-4">
                <div class="flex justify-between items-center mb-4">
                    <button @click="changeMonth(-1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="chevron-left" class="w-5 h-5 text-slate-400"></i></button>
                    <h3 class="font-extrabold text-slate-800 text-lg">{{ currentCalendarYear }} å¹´ {{ currentCalendarMonth + 1 }} æœˆ</h3>
                    <button @click="changeMonth(1)" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100"><i data-lucide="chevron-right" class="w-5 h-5 text-slate-400"></i></button>
                </div>
                
                <div class="calendar-grid mb-2">
                    <div v-for="w in ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­']" class="text-xs font-bold text-slate-300 py-2">{{ w }}</div>
                </div>
                
                <div class="calendar-grid">
                    <div v-for="(day, idx) in calendarDays" :key="idx" 
                         @click="day && selectExpenseDate(day.date)"
                         :class="['calendar-cell', 
                                  !day ? 'invisible' : '', 
                                  day && day.date === selectedExpenseDate ? 'selected' : '', 
                                  day && day.isToday ? 'today' : '',
                                  day && day.hasExpense ? 'has-expense' : '',
                                  'hover:bg-slate-50']">
                        <span v-if="day">{{ day.day }}</span>
                    </div>
                </div>
            </div>

            <div v-if="debts.length > 0" class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <button @click="showSettlement = !showSettlement" class="w-full p-4 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800 text-xs uppercase tracking-widest text-slate-400">çµç®—å»ºè­° & å€‹äººæ”¶æ”¯</h3>
                    <i :data-lucide="showSettlement ? 'chevron-up' : 'chevron-down'" class="w-4 h-4 text-slate-300"></i>
                </button>
                <div v-if="showSettlement" class="animate-fade-in">
                     <div class="p-3 grid grid-cols-2 gap-2 border-b border-slate-50">
                        <div v-for="(balance, member) in balanceList" :key="member" :class="['flex justify-between items-center p-2 rounded-lg text-xs border', balance >= 0 ? 'bg-emerald-50 border-emerald-100 text-emerald-800' : 'bg-red-50 border-red-100 text-red-800']">
                            <span class="font-bold">{{ member }}</span>
                            <span class="font-mono font-bold">{{ balance > 0 ? '+' : '' }}{{ Math.round(balance).toLocaleString() }}</span>
                        </div>
                    </div>
                    <div class="max-h-48 overflow-y-auto no-scrollbar p-5 pt-2">
                        <div v-for="debt in debts" class="flex justify-between items-center py-2 border-b border-slate-50 last:border-0 text-sm">
                            <span class="flex items-center gap-2 font-medium text-slate-600"><span class="bg-slate-100 px-2 py-0.5 rounded text-xs">{{ debt.from }}</span> <i data-lucide="arrow-right" class="w-3 h-3 text-slate-300"></i> <span class="bg-slate-100 px-2 py-0.5 rounded text-xs">{{ debt.to }}</span></span>
                            <span class="font-bold text-emerald-600 font-mono">NT$ {{ debt.amount.toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-extrabold text-slate-800 text-lg flex items-center gap-2">
                        <i data-lucide="calendar-check" class="w-5 h-5 text-blue-500"></i>
                        {{ formatDate(selectedExpenseDate) }} æ”¯å‡ºæ˜ç´°
                    </h3>
                    <span v-if="dailyExpenses.length > 0" class="text-xs font-bold bg-slate-100 px-2 py-1 rounded text-slate-500">æœ¬æ—¥å°è¨ˆ: ${{ dailyTotal.toLocaleString() }}</span>
                </div>

                <div v-if="dailyExpenses.length === 0" class="text-center py-10 bg-white rounded-2xl border border-dashed border-slate-200">
                    <p class="text-slate-300 text-sm font-bold">é€™å¤©é‚„æ²’æœ‰èŠ±éŒ¢ç´€éŒ„å–”</p>
                </div>

                <div class="space-y-3 pb-10">
                    <div v-for="exp in dailyExpenses" :key="exp.id" @click="openEditExpenseModal(exp)" class="bg-white p-4 rounded-2xl shadow-[0_2px_8px_rgba(0,0,0,0.02)] border border-slate-100 relative overflow-hidden cursor-pointer hover:bg-slate-50 transition active:scale-[0.99]">
                        <div class="absolute left-0 top-0 bottom-0 w-1" :class="getGroupColor(exp.splitGroup || 'all')"></div>
                        <div class="flex justify-between items-center pl-2">
                            <div>
                                <div class="flex items-center gap-2">
                                    <p class="font-bold text-slate-800">{{ exp.title }}</p>
                                    <span class="text-[10px] px-1.5 py-0.5 rounded text-white font-bold" :class="getGroupColor(exp.splitGroup || 'all')">{{ getSplitLabel(exp.splitGroup) }}</span>
                                </div>
                                <div class="flex gap-2 items-center text-[10px] text-slate-400 mt-1 font-medium">
                                    <span>{{ exp.payer }} å…ˆä»˜ ({{ exp.currency }} {{ exp.originalAmount }})</span>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-slate-800 font-mono">NT$ {{ Math.round(exp.twdAmount) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <button @click="openAddExpenseModal" class="fixed bottom-24 right-5 w-14 h-14 bg-slate-900 text-white rounded-full shadow-xl flex items-center justify-center active:scale-90 transition-transform z-30 hover:bg-slate-800"><i data-lucide="plus" class="w-7 h-7"></i></button>
        </div>

        <div v-show="activeTab === 'map'" class="h-full w-full relative flex flex-col">
            <div class="absolute top-2 left-0 right-0 z-[1000] px-4">
                <div class="bg-white/90 backdrop-blur-md rounded-2xl shadow-lg border border-slate-200 p-2 flex gap-2 overflow-x-auto no-scrollbar snap-x">
                    <button @click="setMapMode('all')" 
                        :class="['snap-center flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap', 
                        mapMode === 'all' ? 'bg-slate-800 text-white shadow-md' : 'bg-slate-100 text-slate-500']">
                        ğŸŒ å…¨è¦½
                    </button>
                    <div class="w-px bg-slate-300 mx-1 flex-shrink-0"></div>
                    <button v-for="(day, idx) in days" :key="idx" @click="setMapMode('single', day)"
                        :class="['snap-center flex-shrink-0 px-4 py-2 rounded-xl text-xs font-bold transition-all whitespace-nowrap border', 
                        mapMode === 'single' && currentDay === day ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-slate-500 border-slate-200']">
                        {{ day }}
                    </button>
                </div>
            </div>
            
            <div id="map" class="w-full h-full z-0"></div>
            
            <div class="absolute bottom-6 left-4 right-4 z-[1000] flex justify-center">
                <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-xl border border-slate-200 p-1.5 flex gap-1">
                    <button @click="setMapGroupMode('all')" :class="['px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1', mapGroupMode === 'all' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50']"><i data-lucide="eye" class="w-3 h-3"></i> å…¨è¦–è§’</button>
                    <button @click="setMapGroupMode('A')" :class="['px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1', mapGroupMode === 'A' ? 'bg-teal-500 text-white' : 'text-slate-500 hover:bg-slate-50']"><div class="w-2 h-2 rounded-full bg-teal-500" v-if="mapGroupMode!=='A'"></div> è·è˜­çµ„</button>
                    <button @click="setMapGroupMode('B')" :class="['px-3 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-1', mapGroupMode === 'B' ? 'bg-orange-500 text-white' : 'text-slate-500 hover:bg-slate-50']"><div class="w-2 h-2 rounded-full bg-orange-500" v-if="mapGroupMode!=='B'"></div> ä¸‰å°åœ‹</button>
                </div>
            </div>
        </div>

    </main>

    <nav class="bg-white border-t border-slate-100 px-6 py-2 flex justify-between items-center safe-bottom z-30">
        <button v-for="tab in ['itinerary', 'map', 'expenses']" @click="switchTab(tab)" :class="['flex flex-col items-center gap-1 py-1 px-4 rounded-xl transition', activeTab === tab ? 'text-slate-900 bg-slate-50' : 'text-slate-300']">
            <i :data-lucide="getIcon(tab)" class="w-6 h-6 transition-transform duration-200" :class="activeTab===tab ? 'scale-110' : ''"></i><span class="text-[10px] font-bold capitalize">{{ getLabel(tab) }}</span>
        </button>
    </nav>

    <div v-if="showEditModal" class="fixed inset-0 bg-slate-900/40 z-[2000] flex items-end sm:items-center justify-center backdrop-blur-sm p-3 sm:p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 animate-bounce-up shadow-2xl max-h-[90vh] overflow-y-auto relative">
            
            <div v-if="!showCopySelector">
                <div class="flex justify-between items-center mb-6 relative z-50">
                    <h3 class="text-xl font-extrabold text-slate-800">{{ isEditing ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
                    
                    <div class="flex items-center gap-2">
                        <div v-if="isEditing" class="relative">
                            <button @click.stop="toggleMenu" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center transition shadow-sm">
                                <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                            </button>
                            
                            <transition name="menu">
                                <div v-if="showMenu" class="absolute right-0 top-full mt-2 w-40 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-[100] ring-1 ring-black ring-opacity-5">
                                    <button @click="showCopySelector = true; showMenu = false" class="w-full text-left px-4 py-3 text-sm font-bold text-slate-600 hover:bg-slate-50 flex items-center gap-2 border-b border-slate-50">
                                        <i data-lucide="copy" class="w-4 h-4 text-slate-400"></i> è¤‡è£½è¡Œç¨‹
                                    </button>
                                    <button @click="deleteItem(editingItem.id)" class="w-full text-left px-4 py-3 text-sm font-bold text-red-500 hover:bg-red-50 flex items-center gap-2">
                                        <i data-lucide="trash-2" class="w-4 h-4 text-red-400"></i> åˆªé™¤è¡Œç¨‹
                                    </button>
                                </div>
                            </transition>
                        </div>

                        <button @click="showEditModal = false" class="w-10 h-10 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center transition shadow-sm">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div v-if="showMenu" @click="showMenu = false" class="fixed inset-0 z-40 bg-transparent"></div>

                <div class="space-y-5">
                    <div class="flex gap-3">
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">é–‹å§‹æ™‚é–“</label>
                            <div class="relative">
                                <i data-lucide="clock" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                                <input v-model="editingItem.time" type="time" class="w-full bg-slate-50 border border-slate-100 pl-10 pr-3 py-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-800 font-bold text-slate-700">
                            </div>
                        </div>
                        <div class="flex-1">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">åœç•™ (åˆ†)</label>
                            <div class="relative">
                                <i data-lucide="timer" class="absolute left-3 top-3 w-4 h-4 text-slate-400"></i>
                                <input v-model="editingItem.durationMinutes" type="number" class="w-full bg-slate-50 border border-slate-100 pl-10 pr-3 py-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-800 font-bold text-slate-700">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">åƒèˆ‡çµ„åˆ¥</label>
                        <div class="flex bg-slate-100 p-1 rounded-xl">
                            <button v-for="(name, key) in groups" :key="key" @click="editingItem.group = key" class="flex-1 py-2 rounded-lg text-xs font-bold transition-all duration-200" :class="editingItem.group === key ? 'bg-white text-slate-800 shadow-sm scale-[1.02]' : 'text-slate-400 hover:text-slate-600'">
                                {{ name }}
                            </button>
                        </div>
                    </div>
                    
                    <div class="relative z-30">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">åœ°é» (OpenStreetMap)</label>
                        <div class="relative">
                            <i data-lucide="map-pin" class="absolute left-3 top-3.5 w-4 h-4 text-slate-400"></i>
                            <input 
                                v-model="editingItem.location" 
                                @input="searchLocation" 
                                placeholder="è¼¸å…¥é—œéµå­—..." 
                                class="w-full bg-slate-50 border border-slate-100 pl-10 pr-3 py-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-800 font-bold text-slate-700 placeholder-slate-300"
                            >
                        </div>
                        <transition name="fade">
                            <div v-if="suggestions.length > 0" class="suggestions-list">
                                <div v-for="(sug, idx) in suggestions" :key="idx" @click="selectSuggestion(sug)" class="suggestion-item group">
                                    <div class="font-bold text-slate-800 group-hover:text-blue-600">{{ sug.name }}</div>
                                    <div class="text-xs text-slate-400 truncate">{{ sug.display_name }}</div>
                                </div>
                            </div>
                        </transition>
                    </div>

                    <div class="bg-blue-50/50 border border-blue-100 p-4 rounded-xl flex items-center justify-between gap-3">
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase tracking-wider block mb-1">äº¤é€šæ™‚é–“ (åˆ†)</label>
                            <input v-model="editingItem.travelMinutes" type="number" class="w-20 bg-white border border-blue-100 p-2 rounded-lg outline-none text-sm font-bold text-slate-700 text-center focus:ring-2 focus:ring-blue-200">
                        </div>
                        <button @click="openGoogleMapsRoute" class="flex-1 bg-white border border-blue-200 text-blue-600 px-3 py-3 rounded-xl text-sm font-bold shadow-sm active:scale-95 transition flex items-center justify-center gap-2">
                            <i data-lucide="navigation" class="w-4 h-4"></i> Google å°èˆª
                        </button>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">é¡å‹èˆ‡å‚™è¨»</label>
                        
                        <div class="flex gap-2 mb-3 overflow-x-auto no-scrollbar">
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" v-model="editingItem.type" value="spot" class="hidden peer">
                                <div class="px-3 py-2.5 rounded-xl border border-slate-200 text-slate-400 text-center text-xs font-bold transition peer-checked:bg-slate-800 peer-checked:text-white peer-checked:border-slate-800 flex items-center justify-center gap-1.5">
                                    <i data-lucide="camera" class="w-3.5 h-3.5"></i> æ™¯é»
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" v-model="editingItem.type" value="accommodation" class="hidden peer">
                                <div class="px-3 py-2.5 rounded-xl border border-slate-200 text-slate-400 text-center text-xs font-bold transition peer-checked:bg-purple-600 peer-checked:text-white peer-checked:border-purple-600 flex items-center justify-center gap-1.5">
                                    <i data-lucide="bed-double" class="w-3.5 h-3.5"></i> ä½å®¿
                                </div>
                            </label>
                            <label class="flex-1 cursor-pointer">
                                <input type="radio" v-model="editingItem.type" value="flight" class="hidden peer">
                                <div class="px-3 py-2.5 rounded-xl border border-slate-200 text-slate-400 text-center text-xs font-bold transition peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600 flex items-center justify-center gap-1.5">
                                    <i data-lucide="plane" class="w-3.5 h-3.5"></i> ç­æ©Ÿ
                                </div>
                            </label>
                        </div>
                        
                        <textarea v-model="editingItem.note" rows="2" class="w-full bg-slate-50 border border-slate-100 p-3 rounded-xl outline-none focus:ring-2 focus:ring-slate-800 text-sm" placeholder="è¼¸å…¥å‚™è¨»äº‹é …..."></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                    <button @click="showEditModal = false" class="flex-1 py-3.5 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition">å–æ¶ˆ</button>
                    <button @click="saveItem" class="flex-1 py-3.5 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:bg-slate-800 active:scale-95 transition">å„²å­˜</button>
                </div>
            </div>

            <div v-else>
                <div class="text-center mb-6">
                    <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-500">
                        <i data-lucide="copy" class="w-6 h-6"></i>
                    </div>
                    <h3 class="text-xl font-extrabold text-slate-800">è¤‡è£½åˆ°å“ªä¸€å¤©ï¼Ÿ</h3>
                    <p class="text-xs text-slate-400 mt-1">è«‹é¸æ“‡ç›®æ¨™æ—¥æœŸ</p>
                </div>
                
                <div class="grid grid-cols-2 gap-3 max-h-[300px] overflow-y-auto mb-6 p-1">
                    <button v-for="day in days" :key="day" @click="copyToDay(day)" class="p-4 rounded-2xl border-2 border-slate-100 text-sm font-bold hover:border-slate-800 hover:bg-slate-50 transition text-left flex flex-col items-center justify-center gap-1 relative group">
                        <span class="text-slate-800">{{ day }}</span>
                        <span v-if="day === currentDay" class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">ç•¶å‰</span>
                    </button>
                </div>
                <button @click="showCopySelector = false" class="w-full py-3.5 text-slate-500 bg-slate-100 rounded-xl font-bold hover:bg-slate-200 transition">å–æ¶ˆè¿”å›</button>
            </div>

        </div>
    </div>

    <div v-if="showExpenseModal" class="fixed inset-0 bg-slate-900/40 z-[2000] flex items-end sm:items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 animate-bounce-up shadow-2xl relative">
            
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-extrabold text-slate-800">{{ isEditingExpense ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}</h3>
                <button @click="showExpenseModal = false" class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 hover:bg-slate-200 flex items-center justify-center transition">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                     <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">æ—¥æœŸ</label>
                     <input type="date" v-model="newExpense.date" class="w-full bg-slate-50 border border-slate-100 p-3 rounded-xl outline-none font-bold text-slate-700">
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">é …ç›®åç¨±</label>
                    <input v-model="newExpense.title" placeholder="ä¾‹å¦‚ï¼šè¶…å¸‚æ¡è²·" class="w-full bg-slate-50 border border-slate-100 p-3 rounded-xl outline-none font-bold text-slate-700 placeholder-slate-300">
                </div>
                
                <div class="flex gap-2 items-end">
                     <div class="w-24">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">å¹£åˆ¥</label>
                        <select v-model="newExpense.currency" class="w-full bg-slate-50 border border-slate-100 h-[50px] px-2 rounded-xl outline-none text-sm font-bold text-slate-700"><option value="EUR">EUR</option><option value="TWD">TWD</option></select>
                     </div>
                     <div class="flex-1">
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1.5 block">é‡‘é¡</label>
                        <input v-model.number="newExpense.originalAmount" type="number" placeholder="0.00" class="w-full bg-slate-50 border border-slate-100 p-3 rounded-xl outline-none font-bold text-xl text-slate-800 h-[50px]">
                     </div>
                </div>

                <div v-if="newExpense.currency !== 'TWD'" class="bg-yellow-50 border border-yellow-100 p-3 rounded-xl flex justify-between items-center">
                    <label class="text-xs text-yellow-700 font-bold flex items-center gap-1"><i data-lucide="arrow-left-right" class="w-3 h-3"></i> åŒ¯ç‡</label>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-yellow-600 font-medium">1 {{ newExpense.currency }} = </span>
                        <input v-model.number="newExpense.customRate" type="number" step="0.1" class="w-16 bg-white border border-yellow-200 rounded px-1 py-1 text-center font-bold text-slate-700 text-sm">
                        <span class="text-xs text-yellow-600 font-medium">TWD</span>
                    </div>
                </div>
                <div v-if="newExpense.currency !== 'TWD'" class="text-right text-xs font-bold text-slate-400">è©¦ç®—ç´„: NT$ {{ Math.round(newExpense.originalAmount * newExpense.customRate).toLocaleString() }}</div>
                
                <div class="pt-2 border-t border-slate-50 mt-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">åˆ†æ”¤çµ¦èª°ï¼Ÿ</label>
                    <div class="flex gap-2">
                        <button v-for="(name, key) in groups" 
                                :key="key" 
                                @click="newExpense.splitGroup = key" 
                                :class="['flex-1 py-2.5 rounded-xl text-xs font-bold transition-all border', 
                                         newExpense.splitGroup === key ? getGroupBtnColor(key) + ' shadow-md scale-[1.02]' : 'border-slate-200 text-slate-400 hover:border-slate-300']">
                            {{ name }}
                        </button>
                    </div>
                </div>

                <div class="pt-2">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">èª°å…ˆä»˜éŒ¢ï¼Ÿ</label>
                    <div class="flex gap-2 flex-wrap">
                        <button v-for="m in members" @click="newExpense.payer = m" :class="['px-3 py-2 rounded-lg text-xs font-bold border transition-all', newExpense.payer === m ? 'bg-slate-800 text-white border-slate-800 shadow-md' : 'border-slate-200 text-slate-500 hover:border-slate-400']">{{ m }}</button>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-8 pt-4 border-t border-slate-100">
                <button v-if="isEditingExpense" @click="deleteExpense(newExpense.id)" class="px-5 py-3.5 bg-red-50 text-red-500 rounded-xl font-bold hover:bg-red-100 transition flex items-center justify-center"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                <button v-else @click="showExpenseModal = false" class="flex-1 py-3.5 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200 transition">å–æ¶ˆ</button>
                <button @click="submitExpense" class="flex-1 py-3.5 bg-slate-900 text-white rounded-xl font-bold shadow-lg hover:bg-slate-800 active:scale-95 transition">å„²å­˜</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
    import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref as dbRef, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC_trr15i7caUUFXdQeT54rjJj2CbPljlE",
        authDomain: "europetrip2026-d36f1.firebaseapp.com",
        databaseURL: "https://europetrip2026-d36f1-default-rtdb.firebaseio.com",
        projectId: "europetrip2026-d36f1",
        storageBucket: "europetrip2026-d36f1.firebasestorage.app",
        messagingSenderId: "368850353659",
        appId: "1:368850353659:web:8cc22ae3fcf13d11051f5e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    createApp({
        setup() {
            const activeTab = ref('itinerary');
            const showEditModal = ref(false);
            const showExpenseModal = ref(false);
            const showCopySelector = ref(false);
            const showMenu = ref(false);
            const showSettlement = ref(false); // çµç®—å€æŠ˜ç–Šç‹€æ…‹
            const isEditing = ref(false);
            const isEditingExpense = ref(false);
            const dayTitles = ref({}); 
            const isLoaded = ref(false);
            const weatherInfo = ref('');
            const suggestions = ref([]);
            
            const mapMode = ref('single');
            const mapGroupMode = ref('all');
            
            // æœˆæ›†ç›¸é—œç‹€æ…‹
            const calendarDate = ref(new Date(2026, 2, 1)); // é è¨­ 2026å¹´3æœˆ
            const selectedExpenseDate = ref(new Date().toISOString().split('T')[0]); // é è¨­ä»Šå¤©æˆ–æ—…ç¨‹ç¬¬ä¸€å¤©

            const memberConfig = ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†', 'æ©çª', 'ä¸€ä¼‘'];
            const groupConfig = { all: 'å…¨é«”', A: 'è·è˜­çµ„', B: 'ä¸‰å°åœ‹çµ„' };
            const dayConfig = ['3/19', '3/20', '3/21', '3/22', '3/23'];
            const groupMembers = { all: memberConfig, A: ['åª½åª½', 'ä½©çª', 'éŒ¦ç›†'], B: ['æ©çª', 'ä¸€ä¼‘'] };

            const days = ref(dayConfig);
            const currentDay = ref(dayConfig[0]);
            const members = ref(memberConfig);
            const groups = ref(groupConfig);
            const itineraryItems = ref([]);
            const expenses = ref([]);
            const defaultRate = 34.5;

            const editingItem = ref({ id: null, time: '10:00', location: '', note: '', group: 'all', type: 'spot', durationMinutes: 60, travelMinutes: 30 });
            const newExpense = ref({ id: null, title: '', originalAmount: '', currency: 'EUR', customRate: defaultRate, payer: 'åª½åª½', splitGroup: 'all', date: '' });

            let mapInstance = null, markerLayer = L.layerGroup(), polylineLayer = L.layerGroup(), sortableInstance = null;
            let searchTimeout = null;

            const saveToCloud = () => {
                if(!isLoaded.value) return;
                set(dbRef(db, 'travel2026'), {
                    days: days.value,
                    itinerary: itineraryItems.value,
                    expenses: expenses.value,
                    dayTitles: dayTitles.value
                });
            };

            const filteredItinerary = computed(() => itineraryItems.value.filter(i => i.day === currentDay.value).sort((a,b) => a.time.localeCompare(b.time)));
            const totalExpenseTWD = computed(() => expenses.value.reduce((sum, item) => sum + item.twdAmount, 0));
            
            // --- æœˆæ›†é‚è¼¯ ---
            const currentCalendarYear = computed(() => calendarDate.value.getFullYear());
            const currentCalendarMonth = computed(() => calendarDate.value.getMonth());

            const expenseDates = computed(() => {
                const s = new Set();
                expenses.value.forEach(e => s.add(e.date));
                return s;
            });

            const calendarDays = computed(() => {
                const year = currentCalendarYear.value;
                const month = currentCalendarMonth.value;
                const firstDay = new Date(year, month, 1).getDay(); // 0 = Sunday
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const todayStr = new Date().toISOString().split('T')[0];
                
                let daysArr = [];
                for(let i=0; i<firstDay; i++) daysArr.push(null);
                for(let i=1; i<=daysInMonth; i++) {
                    const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    daysArr.push({ 
                        day: i, 
                        date: dateStr, 
                        hasExpense: expenseDates.value.has(dateStr),
                        isToday: dateStr === todayStr
                    });
                }
                return daysArr;
            });

            const dailyExpenses = computed(() => {
                return expenses.value.filter(e => e.date === selectedExpenseDate.value).sort((a,b) => b.id - a.id);
            });

            const dailyTotal = computed(() => {
                return dailyExpenses.value.reduce((sum, e) => sum + e.twdAmount, 0);
            });

            const changeMonth = (delta) => {
                calendarDate.value = new Date(currentCalendarYear.value, currentCalendarMonth.value + delta, 1);
            };

            const selectExpenseDate = (date) => {
                selectedExpenseDate.value = date;
            };

            const formatDate = (dateStr) => {
                if(!dateStr) return 'æœªçŸ¥æ—¥æœŸ';
                const [y, m, d] = dateStr.split('-');
                return `${parseInt(m)}/${parseInt(d)}`;
            };
            
            // --- çµç®—é‚è¼¯ ---
            const getSafeKey = (date) => date.replace('/', '_');

            const updateDayTitle = (e) => {
                const key = getSafeKey(currentDay.value);
                dayTitles.value[key] = e.target.value;
                saveToCloud();
            };

            const balanceList = computed(() => {
                let balances = {}; 
                members.value.forEach(m => balances[m] = 0);
                expenses.value.forEach(ex => {
                    const targetMembers = groupMembers[ex.splitGroup || 'all']; 
                    if (!targetMembers) return;
                    let splitAmount = ex.twdAmount / targetMembers.length;
                    
                    if(balances[ex.payer] !== undefined) balances[ex.payer] += ex.twdAmount;
                    
                    targetMembers.forEach(m => { 
                        if(balances[m] !== undefined) balances[m] -= splitAmount; 
                    });
                });
                return balances;
            });

            const debts = computed(() => {
                let balances = JSON.parse(JSON.stringify(balanceList.value));
                let result = [], debtors = Object.keys(balances).filter(k=>balances[k]<-1), creditors = Object.keys(balances).filter(k=>balances[k]>1);
                
                debtors.forEach(d => { 
                    creditors.forEach(c => {
                        if(balances[d] >= -1 || balances[c] <= 1) return;
                        let amount = Math.min(Math.abs(balances[d]), balances[c]);
                        let roundedAmount = Math.round(amount);
                        
                        if (roundedAmount > 0) {
                            result.push({from:d, to:c, amount: roundedAmount});
                            balances[d] += roundedAmount; 
                            balances[c] -= roundedAmount;
                        }
                    })
                });
                return result;
            });

            const setMapMode = (mode, day = null) => {
                mapMode.value = mode;
                if (day) currentDay.value = day;
                updateMap();
            };

            const setMapGroupMode = (mode) => {
                mapGroupMode.value = mode;
                updateMap();
            };

            const updateMap = () => {
                if(!mapInstance) return;
                markerLayer.clearLayers(); polylineLayer.clearLayers();
                let allLatlngs = [];

                let itemsToDraw = [];
                if (mapMode.value === 'single') {
                    itemsToDraw = itineraryItems.value.filter(i => i.day === currentDay.value);
                } else {
                    itemsToDraw = itineraryItems.value;
                }

                let markersToDraw = [];
                if (mapGroupMode.value === 'all') {
                    markersToDraw = itemsToDraw;
                } else if (mapGroupMode.value === 'A') {
                    markersToDraw = itemsToDraw.filter(i => i.group === 'A' || i.group === 'all');
                } else if (mapGroupMode.value === 'B') {
                    markersToDraw = itemsToDraw.filter(i => i.group === 'B' || i.group === 'all');
                }

                markersToDraw.forEach(item => {
                    if(item.lat && item.lon) {
                        let color = '#3b82f6';
                        if (item.type === 'accommodation') color = '#9333ea';
                        else if (item.group === 'A') color = '#14b8a6';
                        else if (item.group === 'B') color = '#f97316';
                        
                        addMarker(item, color);
                        allLatlngs.push([item.lat, item.lon]);
                    }
                });

                let pathA = [];
                let pathB = [];
                let sortedItems = markersToDraw.sort((a,b) => {
                    if (a.day !== b.day) return days.value.indexOf(a.day) - days.value.indexOf(b.day);
                    return a.time.localeCompare(b.time);
                });

                sortedItems.forEach(item => {
                    if (item.lat && item.lon) {
                        if ((mapGroupMode.value === 'all' || mapGroupMode.value === 'A') && (item.group === 'A' || item.group === 'all')) {
                            pathA.push([item.lat, item.lon]);
                        }
                        if ((mapGroupMode.value === 'all' || mapGroupMode.value === 'B') && (item.group === 'B' || item.group === 'all')) {
                            pathB.push([item.lat, item.lon]);
                        }
                    }
                });

                if(pathA.length > 1) L.polyline(pathA, { color: '#14b8a6', weight: 4, opacity: 0.7, lineCap: 'round', dashArray: null }).addTo(polylineLayer);
                if(pathB.length > 1) L.polyline(pathB, { color: '#f97316', weight: 4, opacity: 0.7, lineCap: 'round', dashArray: mapGroupMode.value === 'all' ? '10, 10' : null }).addTo(polylineLayer);

                if(allLatlngs.length > 0) mapInstance.fitBounds(allLatlngs, {padding:[50,50]});
                else if(allLatlngs.length === 1) mapInstance.setView(allLatlngs[0], 14);
            };

            const addMarker = (item, color) => {
                let iconHtml = '';
                if (item.type === 'accommodation') {
                    iconHtml = `<div style="background-color: ${color}; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.2);"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></svg></div>`;
                } else {
                    iconHtml = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                }

                const icon = L.divIcon({ className: 'custom-div-icon custom-marker', html: iconHtml, iconSize: [28, 28], iconAnchor: [14, 14] });
                
                L.marker([item.lat, item.lon], { icon: icon })
                    .bindPopup(`
                        <div class="p-3 bg-white text-center min-w-[120px]">
                            <span class="text-[10px] font-bold text-white px-2 py-0.5 rounded mb-1.5 inline-block shadow-sm" style="background-color: ${color}">${item.group === 'all' ? 'å…¨é«”' : (item.group==='A'?'è·è˜­çµ„':'ä¸‰å°åœ‹')}</span>
                            <div class="font-bold text-sm text-slate-800 leading-tight">${item.location}</div>
                            <div class="text-[10px] text-slate-400 mt-1 font-mono">${item.time}</div>
                        </div>
                    `)
                    .addTo(markerLayer);
            };

            const searchLocation = () => {
                if (searchTimeout) clearTimeout(searchTimeout);
                suggestions.value = [];
                if (editingItem.value.location.length < 2) return;
                searchTimeout = setTimeout(async () => {
                    try {
                        const q = encodeURIComponent(editingItem.value.location);
                        const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${q}&format=json&limit=5&accept-language=zh-TW`);
                        const data = await res.json();
                        suggestions.value = data.map(item => ({ name: item.name || item.display_name.split(',')[0], display_name: item.display_name, lat: item.lat, lon: item.lon }));
                    } catch (e) {}
                }, 500);
            };

            const selectSuggestion = (sug) => {
                editingItem.value.location = sug.name;
                editingItem.value.lat = sug.lat;
                editingItem.value.lon = sug.lon;
                suggestions.value = [];
            };

            const getNextDate = (dateStr) => {
                const parts = dateStr.split('/');
                const month = parseInt(parts[0]);
                const day = parseInt(parts[1]);
                const date = new Date(2026, month - 1, day);
                date.setDate(date.getDate() + 1);
                return `${date.getMonth() + 1}/${date.getDate()}`;
            };
            const addDay = () => { const last = days.value[days.value.length - 1]; days.value.push(getNextDate(last)); saveToCloud(); };
            const removeDay = () => { if (days.value.length > 1) { const rm = days.value.pop(); if (currentDay.value === rm) currentDay.value = days.value[days.value.length - 1]; saveToCloud(); } else alert('è‡³å°‘è¦ä¿ç•™ä¸€å¤©å–”ï¼'); };

            const getWeather = async () => {
                const items = filteredItinerary.value;
                let lat = 52.3676, lon = 4.9041;
                if(items.length > 0 && items[0].lat) { lat = items[0].lat; lon = items[0].lon; }
                const [m, d] = currentDay.value.split('/');
                const dateStr = `2026-${m.padStart(2,'0')}-${d.padStart(2,'0')}`;
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min&timezone=auto&start_date=${dateStr}&end_date=${dateStr}`);
                    const data = await res.json();
                    if(data.daily && data.daily.temperature_2m_max) weatherInfo.value = `${Math.round(data.daily.temperature_2m_min[0])}Â°C ~ ${Math.round(data.daily.temperature_2m_max[0])}Â°C`;
                    else weatherInfo.value = '';
                } catch(e) { weatherInfo.value = ''; }
            };

            const addMinutesToTime = (timeStr, minutes) => {
                const [h, m] = timeStr.split(':').map(Number);
                const date = new Date(); date.setHours(h, m + minutes, 0, 0);
                return date.toTimeString().slice(0, 5);
            };

            const recalculateTimes = (orderedIds) => {
                let dayItems = itineraryItems.value.filter(i => i.day === currentDay.value);
                let sortedItems = [];
                orderedIds.forEach(id => { const item = dayItems.find(i => i.id == id); if(item) sortedItems.push(item); });
                if(sortedItems.length > 1) {
                    for(let i = 1; i < sortedItems.length; i++) {
                        const prev = sortedItems[i-1];
                        const curr = sortedItems[i];
                        if(curr.type === 'flight') continue;
                        const prevDuration = parseInt(prev.durationMinutes) || 60;
                        const currTravel = parseInt(curr.travelMinutes) || 30;
                        curr.time = addMinutesToTime(prev.time, prevDuration + currTravel);
                    }
                }
                saveToCloud();
            };

            const initSortable = () => {
                const el = document.getElementById('itinerary-list'); if(!el) return;
                if(sortableInstance) sortableInstance.destroy();
                sortableInstance = Sortable.create(el, {
                    animation: 200, delay: 200, delayOnTouchOnly: true, handle: '.itinerary-item', ghostClass: 'sortable-ghost', dragClass: 'sortable-drag',
                    onEnd: function (evt) {
                        const itemEls = el.querySelectorAll('.itinerary-item');
                        const orderedIds = Array.from(itemEls).map(e => e.getAttribute('data-id'));
                        recalculateTimes(orderedIds);
                        activeTab.value = 'expenses'; nextTick(() => activeTab.value = 'itinerary'); 
                    }
                });
            };

            const openAddModal = () => { isEditing.value = false; showCopySelector.value = false; showMenu.value = false; editingItem.value = { id: null, time: '10:00', location: '', note: '', group: 'all', type: 'spot', durationMinutes: 60, travelMinutes: 30 }; suggestions.value = []; showEditModal.value = true; };
            const openEditModal = (item) => { isEditing.value = true; showCopySelector.value = false; showMenu.value = false; editingItem.value = JSON.parse(JSON.stringify(item)); suggestions.value = []; if(!editingItem.value.durationMinutes) editingItem.value.durationMinutes = parseInt(item.duration) || 60; showEditModal.value = true; };
            
            const openAddExpenseModal = () => {
                isEditingExpense.value = false;
                // è‡ªå‹•å¸¶å…¥æœˆæ›†é¸ä¸­çš„æ—¥æœŸ
                const dateToUse = selectedExpenseDate.value || new Date().toISOString().split('T')[0];
                let lastRate = newExpense.value.customRate || defaultRate;
                newExpense.value = { id: null, title: '', originalAmount: '', currency: 'EUR', customRate: lastRate, payer: 'åª½åª½', splitGroup: 'all', date: dateToUse };
                showExpenseModal.value = true;
            };

            const openEditExpenseModal = (exp) => {
                isEditingExpense.value = true;
                newExpense.value = JSON.parse(JSON.stringify(exp));
                showExpenseModal.value = true;
            };

            const copyToDay = (targetDay) => {
                const newItem = {
                    ...editingItem.value,
                    id: Date.now(),
                    day: targetDay
                };
                itineraryItems.value.push(newItem);
                saveToCloud();
                showEditModal.value = false;
                alert(`å·²è¤‡è£½åˆ° ${targetDay}`);
            };

            const toggleMenu = () => {
                showMenu.value = !showMenu.value;
            };

            const saveItem = async () => {
                if(!editingItem.value.location) return;
                editingItem.value.duration = editingItem.value.durationMinutes + 'åˆ†'; editingItem.value.travelTime = editingItem.value.travelMinutes + 'åˆ†';
                if(!editingItem.value.lat || !editingItem.value.lon) {
                     try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${editingItem.value.location}`); const data = await res.json(); if(data.length > 0) { editingItem.value.lat = data[0].lat; editingItem.value.lon = data[0].lon; } } catch(e){}
                }
                if(isEditing.value) { const index = itineraryItems.value.findIndex(i => i.id === editingItem.value.id); if(index !== -1) itineraryItems.value[index] = { ...editingItem.value }; } 
                else { itineraryItems.value.push({ ...editingItem.value, id: Date.now(), day: currentDay.value }); }
                saveToCloud(); showEditModal.value = false;
            };

            const openGoogleMapsRoute = () => { 
                if(!editingItem.value.location) return;
                const url = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(editingItem.value.location)}`;
                window.open(url, '_blank'); 
            };

            const submitExpense = () => { 
                if(!newExpense.value.title || !newExpense.value.originalAmount) return; 
                const rate = newExpense.value.currency === 'TWD' ? 1 : newExpense.value.customRate; 
                const finalAmount = Math.round(newExpense.value.originalAmount * rate);

                if (isEditingExpense.value) {
                    const index = expenses.value.findIndex(e => e.id === newExpense.value.id);
                    if (index !== -1) {
                        expenses.value[index] = { ...newExpense.value, rate: rate, twdAmount: finalAmount };
                    }
                } else {
                    expenses.value.push({ id: Date.now(), ...newExpense.value, rate: rate, twdAmount: finalAmount });
                }
                saveToCloud(); 
                showExpenseModal.value = false; 
            };

            const deleteItem = (id) => { if(confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) { itineraryItems.value = itineraryItems.value.filter(i=>i.id!==id); saveToCloud(); showEditModal.value=false; }};
            
            const deleteExpense = (id) => { 
                if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')) {
                    expenses.value = expenses.value.filter(i=>i.id!==id); 
                    saveToCloud();
                    showExpenseModal.value = false;
                }
            };
            
            const editDayName = (idx) => { const n = prompt('æ—¥æœŸ', days.value[idx]); if(n) { days.value[idx]=n; saveToCloud(); }};
            
            const getGroupColor = (g) => ({all:'bg-blue-500', A:'bg-teal-500', B:'bg-orange-500'}[g]);
            const getGroupBorderLeft = (g) => ({all:'border-l-blue-500', A:'border-l-teal-500', B:'border-l-orange-500'}[g]);
            const getGroupBtnColor = (g) => ({all:'bg-blue-500 text-white border-blue-500', A:'bg-teal-500 text-white border-teal-500', B:'bg-orange-500 text-white border-orange-500'}[g]);
            const getGroupName = (g) => groups.value[g];
            const getSplitLabel = (g) => ({all:'å…¨é«”', A:'è·è˜­çµ„', B:'ä¸‰å°åœ‹çµ„'}[g]);
            const getIcon = (t) => ({itinerary:'calendar', map:'map', expenses:'wallet'}[t]);
            const getLabel = (t) => ({itinerary:'è¡Œç¨‹', map:'åœ°åœ–', expenses:'åˆ†å¸³'}[t]);
            const switchTab = (t) => activeTab.value = t;

            onMounted(() => {
                lucide.createIcons();
                mapInstance = L.map('map').setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'OSM' }).addTo(mapInstance);
                markerLayer.addTo(mapInstance); polylineLayer.addTo(mapInstance);
                
                const dataRef = dbRef(db, 'travel2026');
                onValue(dataRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        if(data.days) days.value = data.days;
                        if(data.itinerary) itineraryItems.value = data.itinerary;
                        if(data.expenses) expenses.value = data.expenses;
                        if(data.dayTitles) dayTitles.value = data.dayTitles || {};
                    }
                    isLoaded.value = true;
                    getWeather();
                    updateMap();
                });

                watch(activeTab, (val) => { if(val==='map') nextTick(() => { mapInstance.invalidateSize(); updateMap(); }); if(val==='itinerary') nextTick(() => initSortable()); nextTick(() => lucide.createIcons()); });
                watch(currentDay, () => { nextTick(() => initSortable()); getWeather(); });
                
                watch(showEditModal, (val) => { if (val) nextTick(() => lucide.createIcons()); });
                watch(showMenu, (val) => { if (val) nextTick(() => lucide.createIcons()); });
                watch(showExpenseModal, (val) => { if (val) nextTick(() => lucide.createIcons()); });
                
                watch(mapGroupMode, () => updateMap());
                watch(filteredItinerary, () => { if(activeTab.value==='map') updateMap(); }, {deep: true});
                
                nextTick(() => initSortable());
            });

            return {
                activeTab, showEditModal, showExpenseModal, isEditing, isEditingExpense, dayTitles, isLoaded, weatherInfo, showSettlement,
                days, currentDay, members, groups, itineraryItems, expenses, editingItem, newExpense, filteredItinerary,
                totalExpenseTWD, debts, balanceList, suggestions, mapMode, mapGroupMode, showCopySelector, showMenu,
                currentCalendarYear, currentCalendarMonth, calendarDays, changeMonth, selectExpenseDate, selectedExpenseDate, dailyExpenses, dailyTotal, formatDate,
                openAddModal, openEditModal, saveItem, deleteItem, openGoogleMapsRoute, submitExpense, deleteExpense, 
                addDay, removeDay, editDayName, saveToCloud, searchLocation, selectSuggestion, setMapMode, setMapGroupMode, openAddExpenseModal, openEditExpenseModal, copyToDay, toggleMenu,
                getGroupColor, getGroupBorderLeft, getGroupName, getGroupBtnColor, getSplitLabel, getIcon, getLabel, switchTab, getSafeKey, updateDayTitle
            };
        }
    }).mount('#app');
</script>
</body>
</html>
